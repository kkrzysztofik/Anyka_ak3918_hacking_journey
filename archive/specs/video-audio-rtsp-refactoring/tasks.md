# Tasks Document

- [ ] 1. Implement RTSP request parser module
  - Files: cross-compile/onvif/src/networking/rtsp/rtsp_request_parser.c, cross-compile/onvif/src/networking/rtsp/rtsp_request_parser.h
  - Create canonical parsing and validation for RTSP methods, URIs, headers, and bodies, emitting populated `rtsp_request_t` structures and rejecting malformed inputs per RFC 2326 sections 4–6.
  - _Leverage: cross-compile/onvif/src/networking/http/http_parser.c, cross-compile/onvif/src/utils/string/string_utils.h_
  - _Requirements: Requirement 1, Requirement 5_
  - _Prompt: Implement the task for spec video-audio-rtsp-refactoring, first run spec-workflow-guide to get the workflow guide then implement the task: Role: C Networking Developer focused on protocol parsing | Task: Build the RTSP request parser module that tokenises methods, URIs, headers, and body payloads, validates header semantics, and fills rtsp_request_t while rejecting malformed requests, reusing HTTP parsing helpers where appropriate | Restrictions: Preserve include ordering standards, no magic return codes, ensure bounds checking on all buffers | _Leverage: cross-compile/onvif/src/networking/http/http_parser.c, cross-compile/onvif/src/utils/string/string_utils.h | _Requirements: Requirement 1, Requirement 5 | Success: Parser handles all RFC 2326 methods, enforces header validation, and has accompanying unit tests passing | Remember to mark this task as [-] when you start and [x] when finished in tasks.md_

- [ ] 2. Implement RTSP state machine engine
  - Files: cross-compile/onvif/src/networking/rtsp/rtsp_state_machine.c, cross-compile/onvif/src/networking/rtsp/rtsp_state_machine.h
  - Encode RFC 2326 session states (INIT, READY, PLAYING, RECORDING) and transitions, enforcing method legality and generating error codes for invalid sequences.
  - _Leverage: cross-compile/onvif/src/networking/rtsp/rtsp_session.c, cross-compile/onvif/src/utils/validation/common_validation.h_
  - _Requirements: Requirement 1_
  - _Prompt: Implement the task for spec video-audio-rtsp-refactoring, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Embedded Protocol Engineer specialising in state machines | Task: Create the RTSP state machine module that enforces RFC 2326 state transitions, integrates with rtsp_session_t, and returns defined error constants for invalid sequences | Restrictions: Maintain thread safety with existing session mutexes, no duplication of session list logic, document transitions with Doxygen | _Leverage: cross-compile/onvif/src/networking/rtsp/rtsp_session.c, cross-compile/onvif/src/utils/validation/common_validation.h | _Requirements: Requirement 1 | Success: All valid method sequences advance state, invalid ones return 455 errors via constants, and unit tests cover transition matrix | Remember to mark this task as [-] when you start and [x] when finished in tasks.md_

- [ ] 3. Build transport negotiation manager
  - Files: cross-compile/onvif/src/networking/rtsp/rtsp_transport_manager.c, cross-compile/onvif/src/networking/rtsp/rtsp_transport_manager.h
  - Implement negotiation for UDP unicast, UDP multicast, and TCP interleaved transports, allocating resources, validating headers, and preparing RTP/RTCP pipelines.
  - _Leverage: cross-compile/onvif/src/networking/rtsp/rtsp_multistream.c, cross-compile/onvif/src/networking/rtsp/rtsp_rtp.c, cross-compile/onvif/src/networking/rtsp/rtsp_rtcp.c_
  - _Requirements: Requirement 2, Requirement 3_
  - _Prompt: Implement the task for spec video-audio-rtsp-refactoring, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Real-time Streaming Engineer | Task: Develop the transport manager that parses Transport headers, negotiates UDP/TCP transports, allocates ports or interleaved channels, and prepares RTP/RTCP contexts for each track | Restrictions: Use predefined error codes for unsupported transports, avoid leaking sockets on failure paths, keep SSRC handling consistent with existing RTP module | _Leverage: cross-compile/onvif/src/networking/rtsp/rtsp_multistream.c, cross-compile/onvif/src/networking/rtsp/rtsp_rtp.c, cross-compile/onvif/src/networking/rtsp/rtsp_rtcp.c | _Requirements: Requirement 2, Requirement 3 | Success: Transport negotiation returns populated rtsp_transport_config_t objects, handles aggregate control, and passes unit tests simulating UDP/TCP setups | Remember to mark this task as [-] when you start and [x] when finished in tasks.md_

- [ ] 4. Refactor SDP and response builder
  - Files: cross-compile/onvif/src/networking/rtsp/rtsp_response_builder.c, cross-compile/onvif/src/networking/rtsp/rtsp_response_builder.h, cross-compile/onvif/src/networking/rtsp/rtsp_sdp.c
  - Produce standards-compliant RTSP responses with correct headers and integrate enhanced SDP generation for multi-track and aggregate control URIs.
  - _Leverage: cross-compile/onvif/src/networking/rtsp/rtsp_sdp.h, cross-compile/onvif/src/utils/string/string_builder.h_
  - _Requirements: Requirement 1, Requirement 2, Requirement 5_
  - _Prompt: Implement the task for spec video-audio-rtsp-refactoring, first run spec-workflow-guide to get the workflow guide then implement the task: Role: C Developer experienced with SDP/RTSP formatting | Task: Construct the response builder that assembles RFC 2326 responses (status line, headers, body) and extend SDP generation to reflect negotiated transports and codecs | Restrictions: Ensure Date, Session, CSeq headers are always present, respect buffer limits, reuse string builder utilities | _Leverage: cross-compile/onvif/src/networking/rtsp/rtsp_sdp.h, cross-compile/onvif/src/utils/string/string_builder.h | _Requirements: Requirement 1, Requirement 2, Requirement 5 | Success: Responses serialize without truncation, SDP bodies validate via ONVIF tools, unit tests confirm header presence | Remember to mark this task as [-] when you start and [x] when finished in tasks.md_

- [ ] 5. Extend session management for aggregate control and auth context
  - Files: cross-compile/onvif/src/networking/rtsp/rtsp_session.c, cross-compile/onvif/src/networking/rtsp/rtsp_session.h, cross-compile/onvif/src/networking/rtsp/rtsp_types.h
  - Augment session structures with state enums, aggregate control mappings, authentication bindings, and timeout policies consistent with refactored modules.
  - _Leverage: cross-compile/onvif/src/networking/rtsp/rtsp_state_machine.h, cross-compile/onvif/src/networking/rtsp/rtsp_transport_manager.h_
  - _Requirements: Requirement 1, Requirement 3, Requirement 4_
  - _Prompt: Implement the task for spec video-audio-rtsp-refactoring, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Embedded Systems Developer maintaining session infrastructure | Task: Extend rtsp_session to store state machine data, transport configs, and auth context, ensuring thread-safe updates and timeout enforcement | Restrictions: Keep global variables compliant with naming rules, maintain mutex coverage, add Doxygen for new fields | _Leverage: cross-compile/onvif/src/networking/rtsp/rtsp_state_machine.h, cross-compile/onvif/src/networking/rtsp/rtsp_transport_manager.h | _Requirements: Requirement 1, Requirement 3, Requirement 4 | Success: Session updates integrate with new modules, timeouts still enforced, unit tests cover new fields and helper functions | Remember to mark this task as [-] when you start and [x] when finished in tasks.md_

- [ ] 6. Extract shared HTTP/RTSP authentication utilities
  - Files: cross-compile/onvif/src/networking/http/http_auth.c, cross-compile/onvif/src/networking/http/http_auth.h, cross-compile/onvif/src/networking/common/network_auth_shared.c, cross-compile/onvif/src/networking/common/network_auth_shared.h
  - Move common digest challenge generation, nonce handling, and header formatting logic into a shared networking module so HTTP and RTSP authentication reuse identical code paths.
  - _Leverage: cross-compile/onvif/src/utils/security/digest_auth.h, cross-compile/onvif/src/networking/http/http_auth.c_
  - _Requirements: Requirement 4, Requirement 5_
  - _Prompt: Implement the task for spec video-audio-rtsp-refactoring, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Security-focused Systems Engineer | Task: Refactor HTTP authentication to extract digest helper routines into networking/common so RTSP security gateway can reuse them without duplication | Restrictions: Maintain backward compatibility for HTTP server, keep include paths relative to src/, add Doxygen and unit coverage for shared helpers | _Leverage: cross-compile/onvif/src/utils/security/digest_auth.h, cross-compile/onvif/src/networking/http/http_auth.c | _Requirements: Requirement 4, Requirement 5 | Success: HTTP auth continues to pass existing tests, shared helpers compile cleanly, RTSP security gateway links against the new module | Remember to mark this task as [-] when you start and [x] when finished in tasks.md_

- [ ] 7. Implement RTSP security gateway
  - Files: cross-compile/onvif/src/networking/rtsp/rtsp_security_gateway.c, cross-compile/onvif/src/networking/rtsp/rtsp_security_gateway.h
  - Centralise digest authentication checks, session binding, and authorisation policy enforcement for RTSP methods using the shared authentication helpers.
  - _Leverage: cross-compile/onvif/src/networking/common/network_auth_shared.h, cross-compile/onvif/src/networking/rtsp/rtsp_auth.c_
  - _Requirements: Requirement 4_
  - _Prompt: Implement the task for spec video-audio-rtsp-refactoring, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Security-focused C Developer | Task: Build the RTSP security gateway that validates credentials, binds them to sessions, enforces method-level permissions, and returns RFC-compliant errors while reusing shared helpers | Restrictions: No plaintext credential logging, reuse digest utilities, respect configurable throttling | _Leverage: cross-compile/onvif/src/networking/common/network_auth_shared.h, cross-compile/onvif/src/networking/rtsp/rtsp_auth.c | _Requirements: Requirement 4 | Success: Authenticated sessions persist across methods, failures emit 401/403 with proper headers, unit tests cover success and denial flows | Remember to mark this task as [-] when you start and [x] when finished in tasks.md_

- [ ] 8. Add RTSP observability instrumentation
  - Files: cross-compile/onvif/src/networking/rtsp/rtsp_observability.c, cross-compile/onvif/src/networking/rtsp/rtsp_observability.h, cross-compile/onvif/src/utils/logging/logging_utils.h
  - Emit structured logs and metric updates for method handling, transport negotiation, RTP quality, security outcomes, and resource usage so the central hub captures the full metrics catalog.
  - _Leverage: cross-compile/onvif/src/networking/http/http_logging.c, cross-compile/onvif/src/networking/common/network_observability.h, platform/platform.h_
  - _Requirements: Requirement 5_
  - _Prompt: Implement the task for spec video-audio-rtsp-refactoring, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Observability Engineer for embedded systems | Task: Create observability hooks that log RTSP requests/responses, transport outcomes, RTP metrics, and security events, publishing updates to the shared observability hub | Restrictions: Avoid excessive log noise, redact credentials, provide clear tags for analytics | _Leverage: cross-compile/onvif/src/networking/http/http_logging.c, cross-compile/onvif/src/networking/common/network_observability.h, platform/platform.h | _Requirements: Requirement 5 | Success: Observability functions publish the defined metrics without contention, integration tests assert metrics presence, logging verbosity is configurable | Remember to mark this task as [-] when you start and [x] when finished in tasks.md_

- [ ] 9. Build central observability and statistics hub
  - Files: cross-compile/onvif/src/networking/common/network_observability.c, cross-compile/onvif/src/networking/common/network_observability.h, cross-compile/onvif/src/networking/http/http_observability_endpoint.c, cross-compile/onvif/src/networking/http/http_observability_endpoint.h
  - Aggregate RTSP and HTTP telemetry into a shared statistics structure that tracks session states, method counters, transport usage, RTP quality metrics (jitter/loss/timestamp drift), security events, resource consumption, and client fingerprints, exposing the data via an HTTP endpoint.
  - _Leverage: cross-compile/onvif/src/utils/logging/logging_utils.h, cross-compile/onvif/src/networking/http/http_server.c_
  - _Requirements: Requirement 5_
  - _Prompt: Implement the task for spec video-audio-rtsp-refactoring, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Embedded Observability Architect | Task: Create a central observability hub with thread-safe aggregation APIs and an HTTP handler that returns JSON snapshots of the full RTSP metrics catalog (sessions, methods, transports, RTP quality, security, resource, client insights) | Restrictions: Keep data structures lightweight, expose only non-sensitive metrics, follow include ordering and documentation standards | _Leverage: cross-compile/onvif/src/utils/logging/logging_utils.h, cross-compile/onvif/src/networking/http/http_server.c | _Requirements: Requirement 5 | Success: HTTP endpoint returns current metrics in structured format, RTSP modules publish stats without contention, unit tests validate aggregation behaviour and JSON output | Remember to mark this task as [-] when you start and [x] when finished in tasks.md_

- [ ] 10. Integrate RTSP configuration with ONVIF media service
  - Files: cross-compile/onvif/src/services/media/onvif_media_service.c, cross-compile/onvif/src/core/config/onvif_config_rtsp.c, cross-compile/onvif/src/core/config/onvif_config_rtsp.h
  - Expose new configuration knobs (timeouts, transport preferences, keep-alive interval, authentication realm, observability toggles) and update GetStreamUri outputs to reflect aggregate control URIs.
  - _Leverage: cross-compile/onvif/src/services/media/onvif_media_service.h, cross-compile/onvif/src/core/config/onvif_config_common.c_
  - _Requirements: Requirement 2, Requirement 3, Requirement 4, Requirement 5_
  - _Prompt: Implement the task for spec video-audio-rtsp-refactoring, first run spec-workflow-guide to get the workflow guide then implement the task: Role: ONVIF Media Service Engineer | Task: Wire new RTSP configuration options into the media service, ensure GetStreamUri advertises compliant URIs, and persist settings via the config subsystem | Restrictions: Maintain existing API contracts, document new settings with Doxygen, reuse config helpers | _Leverage: cross-compile/onvif/src/services/media/onvif_media_service.h, cross-compile/onvif/src/core/config/onvif_config_common.c | _Requirements: Requirement 2, Requirement 3, Requirement 4, Requirement 5 | Success: ONVIF clients receive accurate URIs and transport metadata, configuration persists across reboots, unit tests cover new settings | Remember to mark this task as [-] when you start and [x] when finished in tasks.md_

- [ ] 11. Create RTSP unit test suites
  - Files: cross-compile/onvif/tests/networking/rtsp/test_rtsp_parser.c, cross-compile/onvif/tests/networking/rtsp/test_rtsp_state_machine.c, cross-compile/onvif/tests/networking/rtsp/test_rtsp_transport_manager.c, cross-compile/onvif/tests/networking/rtsp/test_rtsp_security_gateway.c, cross-compile/onvif/tests/networking/common/test_network_observability.c
  - Add CMocka tests covering parser validation, state transitions, transport negotiation edge cases, authentication gateway flows, and observability aggregation.
  - _Leverage: cross-compile/onvif/tests/common/test_utils.h, cross-compile/onvif/tests/networking/rtsp/test_fixtures.h_
  - _Requirements: Requirement 1, Requirement 2, Requirement 3, Requirement 4, Requirement 5_
  - _Prompt: Implement the task for spec video-audio-rtsp-refactoring, first run spec-workflow-guide to get the workflow guide then implement the task: Role: C QA Engineer specialising in CMocka | Task: Author RTSP unit tests that exercise parser, state machine, transport manager, security gateway, and observability helpers using mocks and fixtures | Restrictions: Keep tests isolated, cover boundary conditions, update CMake/Makefiles as needed | _Leverage: cross-compile/onvif/tests/common/test_utils.h, cross-compile/onvif/tests/networking/rtsp/test_fixtures.h | _Requirements: Requirement 1, Requirement 2, Requirement 3, Requirement 4, Requirement 5 | Success: `make test` covers new suites with high branch coverage, failures produce actionable messages | Remember to mark this task as [-] when you start and [x] when finished in tasks.md_

- [ ] 12. Implement RTSP integration tests
  - Files: cross-compile/onvif/tests/networking/rtsp_integration/test_rtsp_full_flow.c, cross-compile/onvif/tests/networking/rtsp_integration/rtsp_test_client.c
  - Simulate full RTSP lifecycles (DESCRIBE → SETUP → PLAY → PAUSE → TEARDOWN), check headers, SDP, and RTCP timing for UDP and TCP transports, and query the observability endpoint to confirm metric updates.
  - _Leverage: cross-compile/onvif/tests/networking/common/socket_test_utils.c, cross-compile/onvif/src/networking/rtsp/rtsp_server.h, cross-compile/onvif/src/networking/common/network_observability.h_
  - _Requirements: Requirement 1, Requirement 2, Requirement 3, Requirement 4, Requirement 5_
  - _Prompt: Implement the task for spec video-audio-rtsp-refactoring, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Integration Test Engineer for streaming protocols | Task: Build integration tests that drive the RTSP server through complete lifecycles for different transports, asserting compliance with RFC 2326 headers/state transitions and verifying observability metrics via HTTP | Restrictions: Use loopback sockets only, ensure tests clean up sessions, add timing tolerances for RTCP checks | _Leverage: cross-compile/onvif/tests/networking/common/socket_test_utils.c, cross-compile/onvif/src/networking/rtsp/rtsp_server.h, cross-compile/onvif/src/networking/common/network_observability.h | _Requirements: Requirement 1, Requirement 2, Requirement 3, Requirement 4, Requirement 5 | Success: Integration suite validates multi-track flows, metrics update as expected, and tests pass consistently in CI | Remember to mark this task as [-] when you start and [x] when finished in tasks.md_

- [ ] 13. Update RTSP E2E scenarios and documentation
  - Files: e2e/rtsp/test_rtsp_e2e.py, docs/refactoring/video-audio-rtsp-refactoring.md, SD_card_contents/anyka_hack/www/docs/admin_rtsp.md
  - Refresh end-to-end tests using real encoder output, capture observability outputs, and document new configuration knobs and troubleshooting steps, including how to interpret RTSP metrics.
  - _Leverage: e2e/common/onvif_client.py, docs/refactoring/onvif-http-refactoring.md_
  - _Requirements: Requirement 2, Requirement 3, Requirement 4, Requirement 5_
  - _Prompt: Implement the task for spec video-audio-rtsp-refactoring, first run spec-workflow-guide to get the workflow guide then implement the task: Role: QA Automation and Documentation Specialist | Task: Update RTSP E2E tests for real streaming validation, capture observability responses, and extend admin documentation with configuration guidance, metrics reference, and troubleshooting tips | Restrictions: Keep documentation ASCII, do not remove existing guidance, ensure tests run against SD-card workflow | _Leverage: e2e/common/onvif_client.py, docs/refactoring/onvif-http-refactoring.md | _Requirements: Requirement 2, Requirement 3, Requirement 4, Requirement 5 | Success: E2E tests validate audio/video sync and keep-alives, documentation reflects new controls/metrics, and observability outputs are captured in test artefacts | Remember to mark this task as [-] when you start and [x] when finished in tasks.md_

- [ ] 14. Final integration, linting, and cleanup
  - Files: cross-compile/onvif/src/networking/rtsp/rtsp_server.c, cross-compile/onvif/src/networking/http/http_server.c, cross-compile/onvif/Makefile, cross-compile/onvif/scripts/lint_code.sh
  - Wire new modules into the RTSP server façade and HTTP observability endpoint, update build scripts, run formatting/linting, and ensure all tests pass.
  - _Leverage: cross-compile/onvif/src/networking/rtsp/rtsp_state_machine.h, cross-compile/onvif/src/networking/common/network_observability.h, cross-compile/onvif/scripts/format_code.sh_
  - _Requirements: Requirement 1, Requirement 2, Requirement 3, Requirement 4, Requirement 5_
  - _Prompt: Implement the task for spec video-audio-rtsp-refactoring, first run spec-workflow-guide to get the workflow guide then implement the task: Role: Senior Integration Engineer | Task: Connect newly created modules into rtsp_server.c and HTTP observability endpoint, adjust Makefiles, run format/lint/test suites, and resolve integration gaps | Restrictions: No regression to existing ONVIF services, run lint_code.sh --check and format_code.sh --check, update documentation headers as needed | _Leverage: cross-compile/onvif/src/networking/rtsp/rtsp_state_machine.h, cross-compile/onvif/src/networking/common/network_observability.h, cross-compile/onvif/scripts/format_code.sh | _Requirements: Requirement 1, Requirement 2, Requirement 3, Requirement 4, Requirement 5 | Success: Build succeeds without warnings, lint/format/tests pass, RTSP server exports new capabilities, and observability endpoint serves live metrics | Remember to mark this task as [-] when you start and [x] when finished in tasks.md_

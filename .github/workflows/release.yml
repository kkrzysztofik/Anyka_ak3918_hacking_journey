name: Release Workflow

on:
  push:
    tags:
      - 'v*'
    branches:
      - main

permissions:
  contents: write

jobs:
  release:
    name: Build and Release
    runs-on: ubuntu-latest
    container:
      image: kkrzysztofik/anyka-cross-compile:latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history needed for changelog generation
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Ensure tag commit is on main
        id: ensure_main
        run: |
          git fetch origin main --prune --depth=1000
          TAG_REF="${GITHUB_REF#refs/tags/}"
          TAG_SHA=$(git rev-parse "$TAG_REF")
          MAIN_SHA=$(git rev-parse origin/main)
          if git merge-base --is-ancestor "$TAG_SHA" "$MAIN_SHA"; then
            echo "on_main=true" >> $GITHUB_OUTPUT
          else
            echo "on_main=false" >> $GITHUB_OUTPUT
            echo "âŒ Tag $TAG_REF is not pointing to a commit on main. Exiting." >&2
            exit 1
          fi

      - name: Configure Git
        run: |
          git config --global --add safe.directory $GITHUB_WORKSPACE
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          # Verify git is working
          git status
          git rev-parse --show-toplevel

      - name: Extract Tag Information
        id: tag_info
        run: |
          if [[ "${{ github.ref }}" =~ refs/tags/(.+) ]]; then
            TAG_NAME="${BASH_REMATCH[1]}"
            echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
            echo "is_tag=true" >> $GITHUB_OUTPUT
          else
            echo "is_tag=false" >> $GITHUB_OUTPUT
            echo "tag_name=" >> $GITHUB_OUTPUT
          fi
          echo "ref=${{ github.ref }}" >> $GITHUB_OUTPUT
          echo "sha=${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Run Full Test Suite
        run: |
          cd cross-compile/onvif
          echo "Running complete test suite..."
          
          # Run unit tests
          echo "=== Running Unit Tests ==="
          make test-unit 2>&1 | tee unit-test-output.log
          
          # Run integration tests  
          echo "=== Running Integration Tests ==="
          make test-integration 2>&1 | tee integration-test-output.log
          
          # Extract test metrics
          chmod +x tests/scripts/extract_test_metrics.sh
          ./tests/scripts/extract_test_metrics.sh \
            --type=unit \
            --test-output=unit-test-output.log \
            --output=unit-metrics.json
            
          ./tests/scripts/extract_test_metrics.sh \
            --type=integration \
            --test-output=integration-test-output.log \
            --output=integration-metrics.json

      - name: Verify Test Results
        run: |
          cd cross-compile/onvif
          
          # Check if unit tests passed
          if [ -f unit-metrics.json ]; then
            UNIT_FAILED=$(jq -r '.tests_failed // 0' unit-metrics.json)
            if [ "$UNIT_FAILED" -gt 0 ]; then
              echo "âŒ Unit tests failed: $UNIT_FAILED failures"
              exit 1
            fi
            echo "âœ… Unit tests passed"
          fi
          
          # Check if integration tests passed
          if [ -f integration-metrics.json ]; then
            INT_FAILED=$(jq -r '.tests_failed // 0' integration-metrics.json)
            if [ "$INT_FAILED" -gt 0 ]; then
              echo "âŒ Integration tests failed: $INT_FAILED failures"
              exit 1
            fi
            echo "âœ… Integration tests passed"
          fi

      - name: Build ONVIF Application
        run: |
          cd cross-compile/onvif
          echo "Building ONVIF application..."
          
          # Clean previous builds
          make clean
          
          # Build release version
          make release
          
          # Verify build succeeded
          if [ ! -f "out/onvifd" ]; then
            echo "âŒ Build failed - onvifd executable not found"
            exit 1
          fi
          
          # Check executable properties
          file out/onvifd
          ls -la out/onvifd
          echo "âœ… ONVIF application built successfully"

      - name: Prepare Release Artifacts
        run: |
          echo "Preparing release artifacts..."
          
          # Create temporary release directory
          mkdir -p release-artifacts
          
          # Copy entire SD_card_contents to release directory
          cp -r SD_card_contents/* release-artifacts/
          
          # Copy newly built executable to onvif directory
          cp cross-compile/onvif/out/onvifd release-artifacts/anyka_hack/onvif/
          
          # Verify the executable was copied
          if [ ! -f "release-artifacts/anyka_hack/onvif/onvifd" ]; then
            echo "âŒ Failed to copy onvifd to release artifacts"
            exit 1
          fi
          
          # Make executable
          chmod +x release-artifacts/anyka_hack/onvif/onvifd
          
          # Show what's in the release
          echo "Release artifacts prepared:"
          find release-artifacts -type f | head -20
          echo "..."
          find release-artifacts -type f | wc -l
          echo "total files in release"

      - name: Generate Release Summary
        id: release_summary
        run: |
          cd cross-compile/onvif
          
          # Load test metrics
          UNIT_TESTS=0
          UNIT_PASSED=0
          UNIT_FAILED=0
          INT_TESTS=0
          INT_PASSED=0
          INT_FAILED=0
          
          if [ -f unit-metrics.json ]; then
            UNIT_TESTS=$(jq -r '.tests_total // 0' unit-metrics.json)
            UNIT_PASSED=$(jq -r '.tests_passed // 0' unit-metrics.json)
            UNIT_FAILED=$(jq -r '.tests_failed // 0' unit-metrics.json)
          fi
          
          if [ -f integration-metrics.json ]; then
            INT_TESTS=$(jq -r '.tests_total // 0' integration-metrics.json)
            INT_PASSED=$(jq -r '.tests_passed // 0' integration-metrics.json)
            INT_FAILED=$(jq -r '.tests_failed // 0' integration-metrics.json)
          fi
          
          TOTAL_TESTS=$((UNIT_TESTS + INT_TESTS))
          TOTAL_PASSED=$((UNIT_PASSED + INT_PASSED))
          TOTAL_FAILED=$((UNIT_FAILED + INT_FAILED))
          
          # Get commit information
          COMMIT_COUNT=$(git rev-list --count HEAD)
          LAST_COMMIT=$(git log -1 --pretty=format:"%h - %s")
          
          # Generate summary
          cat > release-summary.md << EOF
          ## ðŸš€ Anyka AK3918 ONVIF Release ${{ steps.tag_info.outputs.tag_name }}
          
          ### ðŸ“Š Test Results
          - **Total Tests**: $TOTAL_TESTS ($UNIT_TESTS unit + $INT_TESTS integration)
          - **Passed**: $TOTAL_PASSED âœ…
          - **Failed**: $TOTAL_FAILED âŒ
          - **Success Rate**: $(( (TOTAL_PASSED * 100) / TOTAL_TESTS ))%
          
          ### ðŸ—ï¸ Build Information
          - **Commit**: \`${{ github.sha }}\`
          - **Build Type**: Release (optimized)
          - **Cross-compilation**: ARM Anyka AK3918
          - **Executable**: \`onvifd\` (ready for SD card deployment)
          
          ### ðŸ“¦ Release Contents
          - **ONVIF Server**: \`anyka_hack/onvif/onvifd\` (newly built)
          - **Configuration**: \`anyka_hack/onvif/anyka_cfg.ini\`
          - **Libraries**: \`anyka_hack/onvif/lib/\`
          - **Utilities**: Complete SD card payload system
          - **Scripts**: Deployment and monitoring tools
          
          ### ðŸ”§ Installation Instructions
          1. Extract the release archive to your SD card root
          2. Insert SD card into Anyka AK3918 camera
          3. Power on the camera
          4. ONVIF server will start automatically via \`anyka_hack/onvif/run_onvifd.sh\`
          5. Access ONVIF services on port 8080
          
          ### ðŸ“ˆ Recent Changes
          \`\`\`
          $LAST_COMMIT
          \`\`\`
          
          ### ðŸ” Quality Assurance
          - âœ… All unit tests passed ($UNIT_PASSED/$UNIT_TESTS)
          - âœ… All integration tests passed ($INT_PASSED/$INT_TESTS)
          - âœ… Cross-compilation successful
          - âœ… Executable verified and ready for deployment
          
          ---
          *Generated automatically by GitHub Actions on $(date)*
          EOF
          
          # Set outputs for GitHub release
          echo "summary_file=release-summary.md" >> $GITHUB_OUTPUT
          echo "total_tests=$TOTAL_TESTS" >> $GITHUB_OUTPUT
          echo "tests_passed=$TOTAL_PASSED" >> $GITHUB_OUTPUT

      - name: Create Archive
        run: |
          echo "Creating release archive..."
          cd release-artifacts
          tar -czf ../anyka-onvif-${{ steps.tag_info.outputs.tag_name }}.tar.gz .
          cd ..
          ls -la anyka-onvif-${{ steps.tag_info.outputs.tag_name }}.tar.gz

      - name: Create GitHub Release with Auto Notes and Assets
        if: steps.tag_info.outputs.is_tag == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag_info.outputs.tag_name }}
          name: Anyka AK3918 ONVIF Release ${{ steps.tag_info.outputs.tag_name }}
          body_path: release-summary.md
          generate_release_notes: true
          files: |
            anyka-onvif-${{ steps.tag_info.outputs.tag_name }}.tar.gz
            cross-compile/onvif/unit-metrics.json
            cross-compile/onvif/integration-metrics.json

      - name: Release Summary
        run: |
          echo "ðŸŽ‰ Release workflow completed successfully!"
          echo "Tag: ${{ steps.tag_info.outputs.tag_name }}"
          echo "Tests: ${{ steps.release_summary.outputs.total_tests }} total, ${{ steps.release_summary.outputs.tests_passed }} passed"
          echo "Build: ONVIF application ready for deployment"
          echo "Artifacts: SD card contents with updated executable"

name: Shared Security Scans

on:
  workflow_call:
    inputs:
      project_type:
        required: true
        type: string
      working_directory:
        required: true
        type: string
    outputs:
      snyk_code_status:
        description: "Status of Snyk Code scan"
        value: ${{ jobs.snyk-code.outputs.snyk_code_status }}
      snyk_oss_status:
        description: "Status of Snyk Open Source scan"
        value: ${{ jobs.snyk-oss.outputs.snyk_oss_status }}
      snyk_issues:
        description: "Number of Snyk issues found"
        value: ${{ jobs.snyk-oss.outputs.snyk_issues }}
    secrets:
      SNYK_TOKEN:
        required: true

jobs:
  snyk-setup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v6

      - name: Install Snyk CLI
        if: env.SNYK_TOKEN != ''
        run: npm install -g snyk
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

  snyk-code:
    needs: snyk-setup
    runs-on: ubuntu-latest
    continue-on-error: true
    outputs:
      snyk_code_status: ${{ steps.snyk-code.outputs.snyk_code_status }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v6

      - name: Run Snyk Code test
        id: snyk-code
        continue-on-error: true
        working-directory: ${{ inputs.working_directory }}
        run: |
          set +x
          if [ -n "$SNYK_TOKEN" ]; then
            snyk code test --sarif > snyk-code.sarif || true
            echo "snyk_code_status=completed" >> $GITHUB_OUTPUT
          else
            echo "snyk_code_status=skipped" >> $GITHUB_OUTPUT
          fi
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

  snyk-oss:
    needs: snyk-setup
    runs-on: ubuntu-latest
    continue-on-error: true
    outputs:
      snyk_oss_status: ${{ steps.snyk-oss.outputs.snyk_oss_status }}
      snyk_issues: ${{ steps.snyk-oss.outputs.snyk_issues }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v6

      - name: Run Snyk Open Source monitor
        id: snyk-oss
        continue-on-error: true
        working-directory: ${{ inputs.working_directory }}
        run: |
          set +x
          if [ -n "$SNYK_TOKEN" ] && [ -f "package.json" ]; then
            snyk monitor --all-projects || true
            snyk test --file=package.json --json > snyk-oss-results.json 2>&1 || true
            SNYK_ISSUES=$(node -e "const fs = require('fs'); try { const data = JSON.parse(fs.readFileSync('snyk-oss-results.json')); console.log(data.vulnerabilities ? data.vulnerabilities.length : 0); } catch(e) { console.log(0); }" 2>/dev/null || echo "0")
            echo "snyk_issues=$SNYK_ISSUES" >> $GITHUB_OUTPUT
            echo "snyk_oss_status=completed" >> $GITHUB_OUTPUT
          else
            echo "snyk_issues=0" >> $GITHUB_OUTPUT
            echo "snyk_oss_status=skipped" >> $GITHUB_OUTPUT
          fi
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

  upload-sarif:
    needs: snyk-code
    runs-on: ubuntu-latest
    if: always() && needs.snyk-code.outputs.snyk_code_status == 'completed'
    steps:
      - name: Checkout Code
        uses: actions/checkout@v6

      - name: Upload Snyk Code result to GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@v4
        continue-on-error: true
        with:
          sarif_file: ${{ inputs.working_directory }}/snyk-code.sarif

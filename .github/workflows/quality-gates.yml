name: Shared Quality Gates

on:
  workflow_call:
    inputs:
      project_type:
        required: true
        type: string
    outputs:
      sonar-scan-status:
        description: "Status of SonarQube scan"
        value: ${{ jobs.sonar-scan.outputs.sonar-scan-status }}
      quality-gate-status:
        description: "Status of Quality Gate check"
        value: ${{ jobs.sonar-quality-gate.outputs.quality-gate-status }}
    secrets:
      SONAR_TOKEN:
        required: true

jobs:
  sonar-scan:
    name: SonarQube Analysis
    runs-on: ubuntu-latest
    continue-on-error: true
    outputs:
      sonar-scan-status: ${{ steps.sonar-scan.outcome }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Cache Cargo Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            cross-compile/onvif-rust/target
          key: cargo-${{ runner.os }}-sonar-${{ hashFiles('cross-compile/onvif-rust/Cargo.lock') }}
          restore-keys: |
            cargo-${{ runner.os }}-sonar-

      - name: SonarQube Scan
        id: sonar-scan
        continue-on-error: true
        uses: sonarsource/sonarqube-scan-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          projectBaseDir: .

      - name: Upload scannerwork artifacts
        if: always() && steps.sonar-scan.outcome != 'skipped'
        uses: actions/upload-artifact@v4
        continue-on-error: true
        with:
          name: scannerwork
          path: .scannerwork/
          retention-days: 1
          if-no-files-found: ignore

  sonar-quality-gate:
    name: SonarQube Quality Gate
    runs-on: ubuntu-latest
    continue-on-error: true
    needs: sonar-scan
    outputs:
      quality-gate-status: ${{ steps.sonar-quality-gate.outcome || steps.skip-quality-gate.outputs.status || 'skipped' }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Download scannerwork artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: scannerwork
          path: .scannerwork/

      - name: Check if scannerwork exists
        id: check-scannerwork
        run: |
          if [ -f ".scannerwork/report-task.txt" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âœ… Found report-task.txt"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ report-task.txt not found - scan may have failed"
          fi

      - name: SonarQube Quality Gate Check
        id: sonar-quality-gate
        if: steps.check-scannerwork.outputs.exists == 'true'
        continue-on-error: true
        uses: sonarsource/sonarqube-quality-gate-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: Skip Quality Gate (scan failed)
        if: steps.check-scannerwork.outputs.exists != 'true'
        id: skip-quality-gate
        run: |
          echo "âš ï¸ Skipping quality gate check - SonarQube scan did not complete successfully"
          echo "The scan may have failed or the report-task.txt file was not generated"
          echo "status=skipped" >> $GITHUB_OUTPUT

      - name: Generate and Upload SARIF Report
        shell: bash
        run: |
          echo "### ðŸŽ¯ SonarQube Issues Report"
          # Fetch open issues from SonarCloud API
          ISSUES=$(curl -s -u "${{ secrets.SONAR_TOKEN }}:" "https://sonarcloud.io/api/issues/search?componentKeys=kkrzysztofik_Anyka_ak3918_hacking_journey&resolved=false&ps=100")
          COUNT=$(echo $ISSUES | jq '.total')

          # Initialize SARIF structure
          cat > sonar-report.sarif <<EOF
          {
            "\$schema": "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json",
            "version": "2.1.0",
            "runs": [
              {
                "tool": {
                  "driver": {
                    "name": "SonarCloud",
                    "rules": []
                  }
                },
                "results": []
              }
            ]
          }
          EOF

          if [ "$COUNT" -eq "0" ]; then
            echo "âœ… No open issues found in SonarQube."
          else
            echo "âš ï¸ Found $COUNT open issues."
            # Format issues into a readable list for CLI
            echo $ISSUES | jq -r '.issues[] | "- [\(.severity)] \(.message) (\(.component):\(.line))"'

            # Transform SonarCloud JSON to SARIF results using jq
            echo $ISSUES | jq '
              def map_severity(s):
                if s == "BLOCKER" or s == "CRITICAL" then "error"
                elif s == "MAJOR" then "warning"
                else "note" end;

              .issues | map({
                "ruleId": .rule,
                "level": map_severity(.severity),
                "message": { "text": .message },
                "locations": [{
                  "physicalLocation": {
                    "artifactLocation": { "uri": .component | sub("^kkrzysztofik_Anyka_ak3918_hacking_journey:"; "") },
                    "region": { "startLine": (.line // 1) }
                  }
                }]
              })
            ' > sarif-results.json

            # Merge results into the main SARIF file (use --slurpfile as --argfile is deprecated)
            jq --slurpfile results sarif-results.json '.runs[0].results = $results[0]' sonar-report.sarif > sonar-report-final.sarif
            mv sonar-report-final.sarif sonar-report.sarif
          fi
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: Upload SonarCloud Scan Results to GitHub
        uses: github/codeql-action/upload-sarif@v4
        continue-on-error: true
        with:
          sarif_file: sonar-report.sarif

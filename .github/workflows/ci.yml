name: CI - Rust ONVIF API

on:
  pull_request:
    branches:
      - main
    types:
      - opened
      - synchronize
      - reopened
    paths:
      - "cross-compile/onvif-rust/**"

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    container:
      image: kkrzysztofik/anyka-cross-compile:latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Setup Cargo Config
        working-directory: cross-compile/onvif-rust
        run: |
          ./scripts/setup-cargo-config.sh

      - name: Check Formatting
        working-directory: cross-compile/onvif-rust
        run: |
          cargo fmt --check

      - name: Run Clippy
        working-directory: cross-compile/onvif-rust
        run: |
          cargo clippy --target x86_64-unknown-linux-gnu -- -D warnings

  test-and-coverage:
    name: Test Suite & Coverage
    runs-on: ubuntu-latest
    container:
      image: kkrzysztofik/anyka-cross-compile:latest
      options: --security-opt seccomp=unconfined

    steps:
      - name: Checkout Code
        uses: actions/checkout@v6

      - name: Configure Git
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Setup Cargo Config
        working-directory: cross-compile/onvif-rust
        run: |
          ./scripts/setup-cargo-config.sh

      - name: Cache Cargo Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            cross-compile/onvif-rust/target
          key: cargo-${{ runner.os }}-rust-onvif-${{ hashFiles('cross-compile/onvif-rust/Cargo.lock') }}
          restore-keys: |
            cargo-${{ runner.os }}-rust-onvif-

      - name: Run Tests with Coverage
        working-directory: cross-compile/onvif-rust
        run: |
          # Use custom toolchain rustc for host testing
          # Tarpaulin runs tests and generates coverage in one step
          cargo tarpaulin --target x86_64-unknown-linux-gnu --all-features --out Html --out Lcov --out Xml --output-dir coverage

      - name: Upload Coverage HTML
        uses: actions/upload-artifact@v6
        with:
          name: coverage-html
          path: cross-compile/onvif-rust/coverage/tarpaulin-report.html

      - name: Upload Coverage LCOV
        uses: actions/upload-artifact@v6
        with:
          name: coverage-lcov
          path: cross-compile/onvif-rust/coverage/lcov.info

      - name: Upload Coverage Cobertura
        uses: actions/upload-artifact@v6
        with:
          name: coverage-cobertura
          path: cross-compile/onvif-rust/coverage/cobertura.xml

      - name: Generate Coverage Summary
        id: coverage-summary
        working-directory: cross-compile/onvif-rust
        run: |
          if [ -f "coverage/cobertura.xml" ]; then
            # Extract coverage percentage from cobertura XML using Python (available in most containers)
            COVERAGE_PCT=$(python3 -c "import xml.etree.ElementTree as ET; tree = ET.parse('coverage/cobertura.xml'); root = tree.getroot(); rate = float(root.get('line-rate', 0)) * 100; print(f'{rate:.2f}')" 2>/dev/null || echo "0.00")
            echo "coverage=$COVERAGE_PCT" >> $GITHUB_OUTPUT
            echo "âœ… Coverage: ${COVERAGE_PCT}%"
          else
            echo "coverage=0.00" >> $GITHUB_OUTPUT
            echo "âš ï¸ Coverage file not found"
          fi

      - name: Install Snyk CLI
        if: env.SNYK_TOKEN != ''
        run: npm install -g snyk
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: Snyk Code test
        id: snyk-code
        continue-on-error: true
        working-directory: cross-compile/onvif-rust
        run: |
          set +x  # Disable command echo to prevent secret leakage
          # Check if token is available via env var (safer than direct interpolation)
          if [ -n "$SNYK_TOKEN" ]; then
            snyk code test --sarif > snyk-code.sarif || true
            echo "snyk_code_status=completed" >> $GITHUB_OUTPUT
          else
            echo "snyk_code_status=skipped" >> $GITHUB_OUTPUT
          fi
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: Snyk Open Source monitor
        id: snyk-oss
        continue-on-error: true
        working-directory: cross-compile/onvif-rust
        run: |
          set +x  # Disable command echo to prevent secret leakage
          if [ -n "$SNYK_TOKEN" ] && [ -f "Cargo.toml" ]; then
            snyk monitor --all-projects || true
            # Parse results for PR comment
            snyk test --json > snyk-oss-results.json 2>&1 || true
            SNYK_ISSUES=$(cat snyk-oss-results.json | jq -r '.vulnerabilities | length' 2>/dev/null || echo "0")
            echo "snyk_issues=$SNYK_ISSUES" >> $GITHUB_OUTPUT
            echo "snyk_oss_status=completed" >> $GITHUB_OUTPUT
          else
            echo "snyk_issues=0" >> $GITHUB_OUTPUT
            echo "snyk_oss_status=skipped" >> $GITHUB_OUTPUT
          fi
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: Build Docker image for container scanning
        id: build-docker
        continue-on-error: true
        if: env.SNYK_TOKEN != ''
        run: |
          if [ -f "cross-compile/Dockerfile" ]; then
            docker build -t anyka-dev:test -f cross-compile/Dockerfile . || true
            echo "docker_built=true" >> $GITHUB_OUTPUT
          else
            echo "docker_built=false" >> $GITHUB_OUTPUT
          fi
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: Snyk Container monitor
        id: snyk-container
        continue-on-error: true
        if: steps.build-docker.outputs.docker_built == 'true'
        run: |
          set +x  # Disable command echo to prevent secret leakage
          if [ -n "$SNYK_TOKEN" ]; then
            snyk container monitor anyka-dev:test --file=cross-compile/Dockerfile || true
            echo "snyk_container_status=completed" >> $GITHUB_OUTPUT
          else
            echo "snyk_container_status=skipped" >> $GITHUB_OUTPUT
          fi
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: Upload Snyk Code result to GitHub Code Scanning
        if: always() && steps.snyk-code.outputs.snyk_code_status == 'completed'
        uses: github/codeql-action/upload-sarif@v3
        continue-on-error: true
        with:
          sarif_file: cross-compile/onvif-rust/snyk-code.sarif

      - name: SonarQube Scan
        id: sonar-scan
        continue-on-error: true
        uses: sonarsource/sonarqube-scan-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          projectBaseDir: .
          # Configuration is automatically loaded from sonar-project.properties in project root
          # Coverage path is already configured in sonar-project.properties

      - name: SonarQube Quality Gate Check
        id: sonar-quality-gate
        continue-on-error: true
        uses: sonarsource/sonarqube-quality-gate-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: Generate Run Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # ðŸ” CI Analysis Summary - Rust ONVIF API

          ## ðŸ“Š Test Coverage
          - **Coverage**: ${{ steps.coverage-summary.outputs.coverage }}%
          - **Report**: [View Coverage Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ## ðŸ”’ Security Scans (Snyk)
          - **Code (SAST)**: ${{ steps.snyk-code.outputs.snyk_code_status == 'completed' && 'âœ… Completed' || 'âš ï¸ Skipped' }}
          - **Open Source (SCA)**: ${{ steps.snyk-oss.outputs.snyk_oss_status == 'completed' && 'âœ… Completed' || 'âš ï¸ Skipped' }}
          - **Container**: ${{ steps.snyk-container.outputs.snyk_container_status == 'completed' && 'âœ… Completed' || steps.build-docker.outputs.docker_built == 'false' && 'â­ï¸ No Dockerfile' || 'âš ï¸ Skipped' }}
          - **SCA Issues Found**: ${{ steps.snyk-oss.outputs.snyk_issues || '0' }}

          ## ðŸŽ¯ Code Quality (SonarQube)
          - **Status**: ${{ steps.sonar-scan.outcome == 'success' && 'âœ… Passed' || 'âš ï¸ Failed/Skipped' }}
          - **Quality Gate**: ${{ steps.sonar-quality-gate.outcome == 'success' && 'âœ… Passed' || 'âš ï¸ Failed/Skipped' }}

          ## ðŸ“¦ Artifacts
          - Coverage HTML Report
          - Coverage LCOV Report
          - Coverage Cobertura XML

          EOF

      - name: Comment PR with Analysis Results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const coverage = '${{ steps.coverage-summary.outputs.coverage }}';
            const snykCodeStatus = '${{ steps.snyk-code.outputs.snyk_code_status }}';
            const snykOssStatus = '${{ steps.snyk-oss.outputs.snyk_oss_status }}';
            const snykContainerStatus = '${{ steps.snyk-container.outputs.snyk_container_status }}';
            const snykIssues = '${{ steps.snyk-oss.outputs.snyk_issues || 0 }}';
            const dockerBuilt = '${{ steps.build-docker.outputs.docker_built }}';
            const sonarStatus = '${{ steps.sonar-scan.outcome }}';
            const qualityGateStatus = '${{ steps.sonar-quality-gate.outcome }}';

            const comment = `## ðŸ” Code Analysis Results - Rust ONVIF API

            ### ðŸ“Š Test Coverage
            | Metric | Value |
            |--------|-------|
            | **Line Coverage** | ${coverage}% |
            | **Coverage Report** | [View Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) |

            ### ðŸ”’ Security Scans (Snyk)
            | Scan Type | Status | Details |
            |-----------|--------|---------|
            | **Code (SAST)** | ${snykCodeStatus === 'completed' ? 'âœ… Completed' : 'âš ï¸ Skipped'} | [View in Code Scanning](https://github.com/${{ github.repository }}/security/code-scanning) |
            | **Open Source (SCA)** | ${snykOssStatus === 'completed' ? 'âœ… Completed' : 'âš ï¸ Skipped'} | ${snykIssues !== '0' ? `âš ï¸ ${snykIssues} vulnerabilities found` : 'âœ… No issues'} |
            | **Container** | ${dockerBuilt === 'true' ? (snykContainerStatus === 'completed' ? 'âœ… Completed' : 'âš ï¸ Skipped') : 'â­ï¸ No Dockerfile'} | Container image security scan |
            ${snykOssStatus === 'completed' && snykIssues !== '0' ? '| **Action Required** | âš ï¸ Review vulnerabilities in [Snyk Dashboard](https://app.snyk.io/) |' : ''}

            ### ðŸŽ¯ Code Quality (SonarQube)
            | Metric | Value |
            |--------|-------|
            | **Scan Status** | ${sonarStatus === 'success' ? 'âœ… Completed' : 'âš ï¸ Failed/Skipped'} |
            | **Quality Gate** | ${qualityGateStatus === 'success' ? 'âœ… Passed' : 'âš ï¸ Failed/Skipped'} |
            ${sonarStatus === 'success' ? '| **View Report** | [SonarQube Cloud Dashboard](https://sonarcloud.io/dashboard?id=kkrzysztofik_Anyka_ak3918_hacking_journey) |' : ''}

            ---
            *This comment is automatically updated on each push to the PR*`;

            // Find existing bot comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Code Analysis Results - Rust ONVIF API')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment,
              });
            }

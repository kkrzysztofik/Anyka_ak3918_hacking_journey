name: Pull Request Workflow

on:
  pull_request:
    branches:
      - main
    types:
      - opened
      - synchronize
      - reopened

jobs:
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    container:
      image: kkrzysztofik/anyka-cross-compile:latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history needed for git diff
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global --add safe.directory $GITHUB_WORKSPACE
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          # Verify git is working
          git status
          git rev-parse --show-toplevel

      - name: Run Linting Script
        run: |
          cd cross-compile/onvif
          chmod +x scripts/*.sh
          git status
          git log --oneline -5
          ./scripts/lint_code.sh --check --pr-diff

  unit-coverage:
    name: Unit Tests & Coverage
    needs: lint
    runs-on: ubuntu-latest
    container:
      image: kkrzysztofik/anyka-cross-compile:latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configure Git
        run: |
          git config --global --add safe.directory $GITHUB_WORKSPACE
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Run Unit Tests with Coverage
        run: |
          cd cross-compile/onvif/tests
          # Capture test output
          make coverage-html TYPE=unit 2>&1 | tee test-output.log

      - name: Extract Unit Test Metrics
        run: |
          cd cross-compile/onvif/tests
          chmod +x scripts/extract_test_metrics.sh
          ./scripts/extract_test_metrics.sh \
            --type=unit \
            --test-output=test-output.log \
            --coverage-info=coverage/coverage.info \
            --output=metrics-unit.json

      - name: Upload Unit Test Coverage and Metrics
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-coverage
          path: |
            cross-compile/onvif/tests/coverage/
            cross-compile/onvif/tests/metrics-unit.json
          retention-days: 7

  integration-coverage:
    name: Integration Tests & Coverage
    needs: lint
    runs-on: ubuntu-latest
    container:
      image: kkrzysztofik/anyka-cross-compile:latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Configure Git
        run: |
          git config --global --add safe.directory $GITHUB_WORKSPACE
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Run Integration Tests with Coverage
        run: |
          cd cross-compile/onvif/tests
          # Capture test output
          make coverage-html TYPE=integration 2>&1 | tee test-output.log

      - name: Extract Integration Test Metrics
        run: |
          cd cross-compile/onvif/tests
          chmod +x scripts/extract_test_metrics.sh
          ./scripts/extract_test_metrics.sh \
            --type=integration \
            --test-output=test-output.log \
            --coverage-info=coverage/coverage.info \
            --output=metrics-integration.json

      - name: Upload Integration Test Coverage and Metrics
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-coverage
          path: |
            cross-compile/onvif/tests/coverage/
            cross-compile/onvif/tests/metrics-integration.json
          retention-days: 7

  status-comment:
    name: Post Status Comment
    needs: [lint, unit-coverage, integration-coverage]
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Download Unit Test Coverage and Metrics
        uses: actions/download-artifact@v4
        with:
          name: unit-test-coverage
          path: ./coverage-reports/unit

      - name: Download Integration Test Coverage and Metrics
        uses: actions/download-artifact@v4
        with:
          name: integration-test-coverage
          path: ./coverage-reports/integration

      - name: Post PR Comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');

            // Helper function to parse JSON safely
            function loadMetrics(filePath) {
              try {
                const data = fs.readFileSync(filePath, 'utf8');
                return JSON.parse(data);
              } catch (e) {
                console.log(`Could not load metrics from ${filePath}: ${e.message}`);
                return null;
              }
            }

            // Load metrics
            const unitMetrics = loadMetrics('./coverage-reports/unit/metrics-unit.json');
            const integrationMetrics = loadMetrics('./coverage-reports/integration/metrics-integration.json');

            // Check if coverage reports exist
            const unitCoverageExists = fs.existsSync('./coverage-reports/unit');
            const integrationCoverageExists = fs.existsSync('./coverage-reports/integration');

            let comment = '## âœ… Pull Request Checks Passed\n\n';
            comment += 'All automated checks have completed successfully:\n\n';

            // Unit Tests section
            comment += '### ðŸ§ª Unit Tests\n';
            if (unitMetrics) {
              const { tests_total, tests_passed, tests_failed } = unitMetrics;
              const { lines, functions } = unitMetrics.coverage || {};
              comment += `- **Tests**: ${tests_passed} passed, ${tests_failed} failed (${tests_total} total)\n`;
              if (lines && functions) {
                comment += `- **Coverage**: Lines: ${lines}% | Functions: ${functions}%\n`;
              }
            } else {
              comment += '- âœ… Tests passed with coverage\n';
            }
            comment += '\n';

            // Integration Tests section
            comment += '### ðŸ”— Integration Tests\n';
            if (integrationMetrics) {
              const { tests_total, tests_passed, tests_failed } = integrationMetrics;
              const { lines, functions } = integrationMetrics.coverage || {};
              comment += `- **Tests**: ${tests_passed} passed, ${tests_failed} failed (${tests_total} total)\n`;
              if (lines && functions) {
                comment += `- **Coverage**: Lines: ${lines}% | Functions: ${functions}%\n`;
              }
            } else {
              comment += '- âœ… Tests passed with coverage\n';
            }
            comment += '\n';

            // Coverage reports section
            if (unitCoverageExists || integrationCoverageExists) {
              comment += '### ðŸ“Š Coverage Reports\n\n';
              comment += 'Detailed HTML coverage reports are available as workflow artifacts:\n\n';

              if (unitCoverageExists) {
                const unitUrl = './actions/runs/${{ github.run_id }}/artifacts';
                comment += `- [Unit Test Coverage](${unitUrl}) (unit-test-coverage)\n`;
              }

              if (integrationCoverageExists) {
                const intUrl = './actions/runs/${{ github.run_id }}/artifacts';
                comment += `- [Integration Test Coverage](${intUrl}) (integration-test-coverage)\n`;
              }

              comment += '\n';
            }

            // Workflow details section
            comment += '### ðŸ”— Workflow Details\n';
            const runUrl = './actions/runs/${{ github.run_id }}';
            comment += `- **Workflow Run**: [#${{ github.run_number }}](${runUrl})\n`;
            comment += `- **Commit**: \`${{ github.sha }}\`\n`;
            comment += `- **Branch**: \`${{ github.head_ref }}\`\n`;

            const { owner, repo, number } = context.issue;
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: number,
              body: comment
            });

name: Pull Request Workflow

on:
  pull_request:
    branches:
      - main
    types:
      - opened
      - synchronize
      - reopened

jobs:
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    container:
      image: kkrzysztofik/anyka-cross-compile:latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history needed for git diff

      - name: Run Linting Script
        run: |
          cd cross-compile/onvif
          ./scripts/lint_code.sh --check --pr-diff

  unit-test:
    name: Unit Tests
    needs: lint
    runs-on: ubuntu-latest
    container:
      image: kkrzysztofik/anyka-cross-compile:latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Build Tests with Coverage
        run: |
          cd cross-compile/onvif/tests
          make coverage

      - name: Run Unit Tests
        run: |
          cd cross-compile/onvif
          make test-unit

      - name: Generate Coverage Report
        run: |
          cd cross-compile/onvif
          make test-coverage-html

      - name: Upload Unit Test Coverage
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-coverage
          path: cross-compile/onvif/tests/coverage/
          retention-days: 7

  integration-test:
    name: Integration Tests
    needs: lint
    runs-on: ubuntu-latest
    container:
      image: kkrzysztofik/anyka-cross-compile:latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Build Tests with Coverage
        run: |
          cd cross-compile/onvif/tests
          make coverage

      - name: Run Integration Tests
        run: |
          cd cross-compile/onvif
          make test-integration

      - name: Generate Coverage Report
        run: |
          cd cross-compile/onvif
          make test-coverage-html

      - name: Upload Integration Test Coverage
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-coverage
          path: cross-compile/onvif/tests/coverage/
          retention-days: 7

  status-comment:
    name: Post Status Comment
    needs: [lint, unit-test, integration-test]
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Download Unit Test Coverage
        uses: actions/download-artifact@v4
        with:
          name: unit-test-coverage
          path: ./coverage-reports/unit

      - name: Download Integration Test Coverage
        uses: actions/download-artifact@v4
        with:
          name: integration-test-coverage
          path: ./coverage-reports/integration

      - name: Post PR Comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');

            // Check if coverage reports exist
            const unitCoverageExists = fs.existsSync('./coverage-reports/unit');
            const integrationCoverageExists = fs.existsSync(
              './coverage-reports/integration'
            );

            let comment = '## âœ… Pull Request Checks Passed\n\n';
            comment += 'All automated checks have completed successfully:\n\n';
            comment += '- âœ… **Code Linting**: Passed (PR-modified files only)\n';
            comment += '- âœ… **Unit Tests**: Passed with coverage\n';
            comment += '- âœ… **Integration Tests**: Passed with coverage\n\n';

            if (unitCoverageExists || integrationCoverageExists) {
              comment += '### ðŸ“Š Coverage Reports\n\n';
              comment += 'Coverage reports are available as workflow artifacts:\n\n';

              if (unitCoverageExists) {
                const unitUrl = './actions/runs/${{ github.run_id }}/artifacts';
                comment += `- [Unit Test Coverage](${unitUrl}) `;
                comment += '(unit-test-coverage)\n';
              }

              if (integrationCoverageExists) {
                const intUrl = './actions/runs/${{ github.run_id }}/artifacts';
                comment += `- [Integration Test Coverage](${intUrl}) `;
                comment += '(integration-test-coverage)\n';
              }

              comment += '\n';
            }

            comment += '### ðŸ”— Workflow Details\n';
            const runUrl = './actions/runs/${{ github.run_id }}';
            comment += `- **Workflow Run**: [#${{ github.run_number }}](${runUrl})\n`;
            comment += `- **Commit**: \`${{ github.sha }}\`\n`;
            comment += `- **Branch**: \`${{ github.head_ref }}\`\n`;

            const { owner, repo, number } = context.issue;
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: number,
              body: comment
            });

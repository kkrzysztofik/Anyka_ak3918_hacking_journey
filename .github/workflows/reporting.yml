name: Shared Reporting

on:
  workflow_call:
    inputs:
      project_type:
        required: true
        type: string
      test_coverage:
        required: false
        type: string
      snyk_code_status:
        required: false
        type: string
        default: "skipped"
      snyk_oss_status:
        required: false
        type: string
        default: "skipped"
      snyk_issues:
        required: false
        type: string
        default: "0"
      sonar_scan_status:
        required: false
        type: string
        default: "skipped"
      quality_gate_status:
        required: false
        type: string
        default: "skipped"

jobs:
  generate-summary:
    name: Generate CI Summary
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Generate Run Summary
        run: |
          # Helper function to get status emoji
          get_status() {
            case "$1" in
              success) echo "âœ… Completed" ;;
              failure) echo "âš ï¸ Failed" ;;
              *) echo "âš ï¸ Skipped" ;;
            esac
          }

          get_quality_gate_status() {
            case "$1" in
              success) echo "âœ… Passed" ;;
              failure) echo "âš ï¸ Failed" ;;
              *) echo "âš ï¸ Skipped" ;;
            esac
          }

          SNYK_CODE_STATUS=$(get_status "${{ inputs.snyk_code_status }}")
          SNYK_OSS_STATUS=$(get_status "${{ inputs.snyk_oss_status }}")
          SONAR_SCAN_STATUS=$(get_status "${{ inputs.sonar_scan_status }}")
          QUALITY_GATE_STATUS=$(get_quality_gate_status "${{ inputs.quality_gate_status }}")

          cat >> $GITHUB_STEP_SUMMARY << EOF
          # ðŸ” CI Analysis Summary - ${{ inputs.project_type }}

          ## ðŸ“Š Test Coverage
          - **Coverage**: ${{ inputs.test_coverage || 'N/A' }}%
          - **Report**: [View Coverage Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ## ðŸ”’ Security Scans (Snyk)
          - **Code (SAST)**: ${SNYK_CODE_STATUS}
          - **Open Source (SCA)**: ${SNYK_OSS_STATUS}
          - **SCA Issues Found**: ${{ inputs.snyk_issues || '0' }}

          ## ðŸŽ¯ Code Quality (SonarQube)
          - **Status**: ${SONAR_SCAN_STATUS}
          - **Quality Gate**: ${QUALITY_GATE_STATUS}

          ## ðŸ“¦ Build Status
          - **Build**: âœ… Successful
          - **Lint**: âœ… Passed
          - **Tests**: âœ… Passed
          EOF

  comment-pr:
    name: Comment PR with Results
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Comment PR with Analysis Results
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const projectType = '${{ inputs.project_type }}';
            const coverage = '${{ inputs.test_coverage || '0' }}';
            const snykCodeStatus = '${{ inputs.snyk_code_status }}';
            const snykOssStatus = '${{ inputs.snyk_oss_status }}';
            const snykIssues = '${{ inputs.snyk_issues || 0 }}';
            const sonarStatus = '${{ inputs.sonar_scan_status }}';
            const qualityGateStatus = '${{ inputs.quality_gate_status }}';

            const comment = `## ðŸ” Code Analysis Results - ${projectType}

            ### ðŸ“Š Test Coverage
            | Metric | Value |
            |--------|-------|
            | **Line Coverage** | ${coverage}% |
            | **Coverage Report** | [View Artifacts](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) |

            ### ðŸ”’ Security Scans (Snyk)
            | Scan Type | Status | Details |
            |-----------|--------|---------|
            | **Code (SAST)** | ${snykCodeStatus === 'success' ? 'âœ… Completed' : (snykCodeStatus === 'failure' ? 'âš ï¸ Failed' : 'âš ï¸ Skipped')} | [View in Code Scanning](https://github.com/${context.repo.owner}/${context.repo.repo}/security/code-scanning) |
            | **Open Source (SCA)** | ${snykOssStatus === 'success' ? 'âœ… Completed' : (snykOssStatus === 'failure' ? 'âš ï¸ Failed' : 'âš ï¸ Skipped')} | ${snykIssues !== '0' ? `âš ï¸ ${snykIssues} vulnerabilities found` : 'âœ… No issues'} |
            ${snykOssStatus === 'success' && snykIssues !== '0' ? '| **Action Required** | âš ï¸ Review vulnerabilities in [Snyk Dashboard](https://app.snyk.io/) |' : ''}

            ### ðŸŽ¯ Code Quality (SonarQube)
            | Metric | Value |
            |--------|-------|
            | **Scan Status** | ${sonarStatus === 'success' ? 'âœ… Completed' : (sonarStatus === 'failure' ? 'âš ï¸ Failed' : 'âš ï¸ Skipped')} |
            | **Quality Gate** | ${qualityGateStatus === 'success' ? 'âœ… Passed' : (qualityGateStatus === 'failure' ? 'âš ï¸ Failed' : 'âš ï¸ Skipped')} |
            ${sonarStatus === 'success' ? '| **View Report** | [SonarQube Cloud Dashboard](https://sonarcloud.io/dashboard?id=kkrzysztofik_Anyka_ak3918_hacking_journey) |' : ''}

            ### âœ… Build Status
            - **Lint**: âœ… Passed
            - **Tests**: âœ… Passed
            - **Build**: âœ… Successful

            ---
            *This comment is automatically updated on each push to the PR*`;

            // Find existing bot comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Code Analysis Results - ' + projectType)
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment,
              });
            }

name: WebUI CI

on:
  push:
    branches: [main]
    paths:
      - "cross-compile/www/**"
  pull_request:
    branches: [main]
    paths:
      - "cross-compile/www/**"

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: cross-compile/www

    steps:
      - uses: actions/checkout@v6

      - name: Use Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "24"
          cache: "npm"
          cache-dependency-path: cross-compile/www/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Test with Coverage
        id: test-coverage
        run: |
          npm run test -- --coverage
          # Extract coverage from summary if available
          if [ -f "coverage/coverage-summary.json" ]; then
            COVERAGE=$(node -e "const fs = require('fs'); const data = JSON.parse(fs.readFileSync('coverage/coverage-summary.json')); console.log(data.total.lines.pct.toFixed(2))")
            echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
            echo "âœ… Coverage: ${COVERAGE}%"
          else
            echo "coverage=0" >> $GITHUB_OUTPUT
            echo "âš ï¸ Coverage file not found"
          fi

      - name: Upload Coverage Reports
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: coverage-reports
          path: |
            cross-compile/www/coverage/**
          retention-days: 7

      - name: Build
        run: npm run build

      - name: Run Snyk Security Scan
        id: snyk-scan
        continue-on-error: true
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --file=cross-compile/www/package.json --monitor --json-file-output=snyk-results.json || true
        if: always()

      - name: Parse Snyk Results
        id: parse-snyk
        if: always() && steps.snyk-scan.outcome != 'skipped'
        run: |
          if [ -f "snyk-results.json" ]; then
            SNYK_ISSUES=$(node -e "const fs = require('fs'); try { const data = JSON.parse(fs.readFileSync('snyk-results.json')); console.log(data.vulnerabilities ? data.vulnerabilities.length : 0); } catch(e) { console.log(0); }" 2>/dev/null || echo "0")
            echo "snyk_issues=$SNYK_ISSUES" >> $GITHUB_OUTPUT
            echo "snyk_status=completed" >> $GITHUB_OUTPUT
          else
            echo "snyk_issues=0" >> $GITHUB_OUTPUT
            echo "snyk_status=skipped" >> $GITHUB_OUTPUT
          fi

      - name: SonarQube Scan
        id: sonar-scan
        continue-on-error: true
        uses: sonarsource/sonarqube-scan-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
        with:
          projectBaseDir: .
          # Configuration is automatically loaded from sonar-project.properties in project root
          # Coverage path is already configured in sonar-project.properties

      - name: SonarQube Quality Gate Check
        id: sonar-quality-gate
        continue-on-error: true
        uses: sonarsource/sonarqube-quality-gate-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

      - name: Generate Run Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # ðŸ” CI Analysis Summary - WebUI

          ## ðŸ“Š Test Coverage
          - **Coverage**: ${{ steps.test-coverage.outputs.coverage }}%
          - **Report**: [View Coverage Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ## ðŸ”’ Security Scan (Snyk)
          - **Status**: ${{ steps.parse-snyk.outputs.snyk_status }}
          - **Issues Found**: ${{ steps.parse-snyk.outputs.snyk_issues }}

          ## ðŸŽ¯ Code Quality (SonarQube)
          - **Status**: ${{ steps.sonar-scan.outcome == 'success' && 'âœ… Passed' || 'âš ï¸ Failed/Skipped' }}
          - **Quality Gate**: ${{ steps.sonar-quality-gate.outcome == 'success' && 'âœ… Passed' || 'âš ï¸ Failed/Skipped' }}

          ## ðŸ“¦ Build Status
          - **Build**: âœ… Successful
          - **Lint**: âœ… Passed
          - **Tests**: âœ… Passed

          EOF

      - name: Comment PR with Analysis Results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const coverage = '${{ steps.test-coverage.outputs.coverage }}';
            const snykStatus = '${{ steps.parse-snyk.outputs.snyk_status }}';
            const snykIssues = '${{ steps.parse-snyk.outputs.snyk_issues }}';
            const sonarStatus = '${{ steps.sonar-scan.outcome }}';
            const qualityGateStatus = '${{ steps.sonar-quality-gate.outcome }}';

            const comment = `## ðŸ” Code Analysis Results - WebUI

            ### ðŸ“Š Test Coverage
            | Metric | Value |
            |--------|-------|
            | **Line Coverage** | ${coverage}% |
            | **Coverage Report** | [View Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) |

            ### ðŸ”’ Security Scan (Snyk)
            | Metric | Value |
            |--------|-------|
            | **Status** | ${snykStatus === 'completed' ? 'âœ… Completed' : 'âš ï¸ Skipped'} |
            | **Vulnerabilities Found** | ${snykIssues} |
            ${snykStatus === 'completed' && snykIssues !== '0' ? '| **Action Required** | âš ï¸ Review vulnerabilities in [Snyk Dashboard](https://app.snyk.io/) |' : ''}

            ### ðŸŽ¯ Code Quality (SonarQube)
            | Metric | Value |
            |--------|-------|
            | **Scan Status** | ${sonarStatus === 'success' ? 'âœ… Completed' : 'âš ï¸ Failed/Skipped'} |
            | **Quality Gate** | ${qualityGateStatus === 'success' ? 'âœ… Passed' : 'âš ï¸ Failed/Skipped'} |
            ${sonarStatus === 'success' ? '| **View Report** | [SonarQube Dashboard](${{ secrets.SONAR_HOST_URL }}/dashboard?id=anyka-dev) |' : ''}

            ### âœ… Build Status
            - **Lint**: âœ… Passed
            - **Tests**: âœ… Passed
            - **Build**: âœ… Successful

            ---
            *This comment is automatically updated on each push to the PR*`;

            // Find existing bot comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Code Analysis Results - WebUI')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment,
              });
            }

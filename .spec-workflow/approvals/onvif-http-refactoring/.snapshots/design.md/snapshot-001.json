{
  "id": "snapshot_1758873460607_djey65s4u",
  "approvalId": "approval_1758873460603_ja0t1gqr6",
  "approvalTitle": "ONVIF HTTP Refactoring - Design Document",
  "version": 1,
  "timestamp": "2025-09-26T07:57:40.607Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document - ONVIF HTTP Refactoring\r\n\r\n## Overview\r\n\r\nThis design transforms the ONVIF HTTP service architecture from a memory-inefficient, complex system with security vulnerabilities into an optimized, secure, and maintainable implementation. The refactoring eliminates 128KB fixed allocations in favor of dynamic sizing, removes unnecessary adapter layers, enables proper authentication, and standardizes response handling across all ONVIF services.\r\n\r\nThe design preserves all existing ONVIF functionality while achieving a 65%+ reduction in memory usage and eliminating security vulnerabilities through comprehensive input validation and authentication enablement.\r\n\r\n## Steering Document Alignment\r\n\r\n### Technical Standards (tech.md)\r\nThe design strictly follows AGENTS.md coding standards including:\r\n- Relative include paths from `src/` directory\r\n- Global variable naming convention `g_<module>_<variable_name>`\r\n- Comprehensive Doxygen documentation for all functions\r\n- Use of existing utilities to prevent code duplication\r\n- Safe string functions and proper input validation\r\n\r\n### Project Structure (structure.md)\r\nImplementation follows the established project structure:\r\n- Services organized under `src/services/{service}/`\r\n- Utilities leveraged from `src/utils/`\r\n- Platform abstraction maintained via `src/platform/`\r\n- Network components in `src/networking/`\r\n\r\n## Code Reuse Analysis\r\n\r\n### Existing Components to Leverage\r\n- **memory_manager.c/h**: Dynamic buffer allocation and tracking system for small response optimization\r\n- **buffer_pool.c/h**: Pre-allocated buffer pool for medium response optimization\r\n- **security_hardening.c/h**: Authentication and validation functions (currently bypassed)\r\n- **platform_logging.c/h**: Logging infrastructure for debugging and security events\r\n- **string_shims.c/h**: Safe string manipulation functions\r\n- **error_handling.c/h**: Consistent error reporting mechanisms\r\n\r\n### Integration Points\r\n- **HTTP Server**: Direct service invocation without adapter conversion\r\n- **gSOAP Context**: XML/SOAP processing using existing infrastructure\r\n- **Thread Pool**: Existing connection management for concurrent requests\r\n- **Configuration System**: Leverage existing device configuration for service parameters\r\n\r\n## Architecture\r\n\r\nThe refactored architecture eliminates unnecessary abstraction layers and implements memory-efficient response handling:\r\n\r\n### Modular Design Principles\r\n- **Single File Responsibility**: Each service handles one ONVIF service type (Device, Media, PTZ, Imaging)\r\n- **Component Isolation**: Response builders, validators, and memory managers are separate utilities\r\n- **Service Layer Separation**: Clear separation between HTTP handling, service logic, and response generation\r\n- **Utility Modularity**: Memory management, validation, and logging are focused, reusable modules\r\n\r\n```mermaid\r\ngraph TD\r\n    A[HTTP Request] --> B[Security Validation]\r\n    B --> C[Input Validation]\r\n    C --> D[Service Router]\r\n    D --> E[Device Service]\r\n    D --> F[Media Service]\r\n    D --> G[PTZ Service]\r\n    D --> H[Imaging Service]\r\n    E --> I[Smart Response Builder]\r\n    F --> I\r\n    G --> I\r\n    H --> I\r\n    I --> J[Memory Strategy]\r\n    J --> K[Dynamic Buffer <4KB]\r\n    J --> L[Buffer Pool 4-32KB]\r\n    J --> M[Direct Alloc >32KB]\r\n    K --> N[HTTP Response]\r\n    L --> N\r\n    M --> N\r\n```\r\n\r\n## Components and Interfaces\r\n\r\n### HTTP Request Validator\r\n- **Purpose:** Validate HTTP headers, content-type, body presence, and size limits\r\n- **Interfaces:** `validate_http_request(const http_request_t* request) -> int`\r\n- **Dependencies:** Platform logging for security event recording\r\n- **Reuses:** Existing `http_request_t` structure and security logging\r\n\r\n### SOAP Envelope Validator\r\n- **Purpose:** Validate SOAP structure and prevent XML injection attacks\r\n- **Interfaces:** `validate_soap_envelope(const char* soap_body, size_t length) -> int`\r\n- **Dependencies:** String utilities for safe parsing\r\n- **Reuses:** Existing string_shims.c safe string functions\r\n\r\n### Smart Response Builder\r\n- **Purpose:** Optimize memory allocation based on response size with strategy selection\r\n- **Interfaces:**\r\n  - `build_optimized_response(onvif_response_t* response, const char* content, size_t hint) -> int`\r\n  - `build_small_response_dynamic(onvif_response_t* response, const char* content) -> int`\r\n  - `build_medium_response_pooled(onvif_response_t* response, const char* content) -> int`\r\n- **Dependencies:** memory_manager.c, buffer_pool.c, platform_logging.c\r\n- **Reuses:** Existing dynamic_buffer_t, buffer_pool_t, and ONVIF_MALLOC/FREE tracking\r\n\r\n### Service Handler Standardizer\r\n- **Purpose:** Provide consistent service handler interface across all ONVIF services\r\n- **Interfaces:** `enhanced_service_handler(config, request, response, gsoap_ctx) -> int`\r\n- **Dependencies:** Smart response builder, validation components\r\n- **Reuses:** Existing service_handler_config_t and onvif_response_t structures\r\n\r\n### Memory Allocation Strategy\r\n- **Purpose:** Determine optimal allocation method based on response size estimation\r\n- **Interfaces:** Internal logic within Smart Response Builder\r\n- **Dependencies:** Dynamic buffer and buffer pool systems\r\n- **Reuses:** Existing memory management infrastructure without modification\r\n\r\n## Data Models\r\n\r\n### Enhanced Service Response Structure\r\n```c\r\ntypedef struct {\r\n    char* body;                    // Response content (dynamically allocated)\r\n    size_t body_length;           // Actual content length\r\n    int status_code;              // HTTP status code\r\n    const char* content_type;     // Content type header\r\n    allocation_strategy_t strategy; // Which allocation method was used\r\n} onvif_response_t;\r\n```\r\n\r\n### Memory Strategy Enumeration\r\n```c\r\ntypedef enum {\r\n    STRATEGY_SMALL_DYNAMIC,       // <4KB using dynamic_buffer_t\r\n    STRATEGY_MEDIUM_POOLED,       // 4-32KB using buffer_pool_t\r\n    STRATEGY_LARGE_DIRECT,        // >32KB using direct allocation\r\n    STRATEGY_ERROR_FALLBACK       // Error handling allocation\r\n} allocation_strategy_t;\r\n```\r\n\r\n### Validation Result Structure\r\n```c\r\ntypedef struct {\r\n    int result;                   // 0 = valid, -1 = invalid\r\n    const char* error_code;       // SOAP fault code if invalid\r\n    const char* error_message;    // Human readable error\r\n    security_threat_level_t threat; // Security assessment\r\n} validation_result_t;\r\n```\r\n\r\n## Error Handling\r\n\r\n### Error Scenarios\r\n1. **Memory Allocation Failure:**\r\n   - **Handling:** Graceful fallback to smaller allocation strategies, return appropriate SOAP fault\r\n   - **User Impact:** Service temporarily unavailable response with retry suggestion\r\n\r\n2. **Authentication Failure:**\r\n   - **Handling:** Return HTTP 401 with proper WWW-Authenticate header\r\n   - **User Impact:** Clear authentication error requiring credential check\r\n\r\n3. **XML Injection Attempt:**\r\n   - **Handling:** Block request, log security event, return generic error\r\n   - **User Impact:** Request rejected without revealing security detection\r\n\r\n4. **Buffer Pool Exhaustion:**\r\n   - **Handling:** Automatic fallback to direct allocation with warning log\r\n   - **User Impact:** No visible impact, slight performance degradation\r\n\r\n5. **Malformed SOAP Request:**\r\n   - **Handling:** Validate and return specific SOAP fault with error location\r\n   - **User Impact:** Clear error message indicating request format issue\r\n\r\n## Testing Strategy\r\n\r\n### Unit Testing\r\n- Response builder allocation strategies with various size inputs\r\n- Validation functions with known good/bad inputs\r\n- Memory management correctness and leak detection\r\n- Service handler error path coverage\r\n- Buffer pool get/return cycle testing\r\n\r\n### Integration Testing\r\n- End-to-end request processing through all validation and response stages\r\n- Authentication flow testing with valid/invalid credentials\r\n- Concurrent request handling with buffer pool utilization\r\n- Memory optimization verification across all service types\r\n- Security validation against common attack vectors\r\n\r\n### End-to-End Testing\r\n- Full ONVIF client compatibility testing with GetDeviceInformation, GetCapabilities\r\n- Performance benchmarking comparing before/after memory usage\r\n- Security penetration testing against authentication bypass and injection\r\n- Stress testing with concurrent connections and varying response sizes\r\n- Regression testing ensuring all existing functionality preserved",
  "fileStats": {
    "size": 8489,
    "lines": 186,
    "lastModified": "2025-09-26T07:57:34.690Z"
  },
  "comments": []
}
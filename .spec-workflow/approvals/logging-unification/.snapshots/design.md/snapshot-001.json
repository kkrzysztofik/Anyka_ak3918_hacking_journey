{
  "id": "snapshot_1758957588468_g290sm3uk",
  "approvalId": "approval_1758957588463_vo8a53l4b",
  "approvalTitle": "Logging Unification Design",
  "version": 1,
  "timestamp": "2025-09-27T07:19:48.468Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document\r\n\r\n## Overview\r\n\r\nThe unified logging system will replace four fragmented logging implementations with a single, function-based API that provides consistent, debuggable, and performance-optimized logging for the entire ONVIF project. The design focuses on simplicity, reliability, and embedded systems optimization while maintaining the standardized log format: `YYYY-MM-DD HH:MM:SS,mmm LEVEL [HOSTNAME] component.path.identifier Message text`.\r\n\r\nThe system will be implemented as a standalone utility module that integrates seamlessly with the existing configuration system and provides thread-safe logging operations with minimal overhead.\r\n\r\n## Steering Document Alignment\r\n\r\n### Technical Standards (tech.md)\r\n\r\n**Language Compliance**: The implementation follows C99 standards with GCC cross-compiler compatibility for ARM architecture (Anyka AK3918 SoC).\r\n\r\n**Dependency Management**: The unified logging system has minimal dependencies, using only standard C libraries (`stdio.h`, `time.h`, `pthread.h`) and the existing configuration system, maintaining the project's lightweight embedded systems philosophy.\r\n\r\n**Performance Requirements**: The design ensures sub-second response times by implementing early return optimization for disabled log levels and using fixed memory buffers to avoid dynamic allocation overhead.\r\n\r\n**Security Standards**: The implementation includes comprehensive input validation, format string attack prevention, and buffer overflow protection, maintaining the project's \"Security First\" principle.\r\n\r\n### Project Structure (structure.md)\r\n\r\n**Utility Organization**: The unified logging system will be placed in `src/utils/logging/` following the established utility module pattern, with clear separation between header interface and implementation.\r\n\r\n**Naming Conventions**: All functions follow the `log_<level>()` pattern, global variables use `g_log_<name>` format, and types use `log_<type>_t` suffixes, consistent with project standards.\r\n\r\n**Include Patterns**: The implementation follows the mandatory include order: system headers, third-party libraries, project headers, ensuring consistent and predictable compilation.\r\n\r\n**Documentation**: All functions include comprehensive Doxygen documentation with `@brief`, `@param`, and `@return` tags, supporting the project's documentation standards.\r\n\r\n## Code Reuse Analysis\r\n\r\n### Existing Components to Leverage\r\n\r\n- **Configuration System** (`src/core/config/config.h`): The existing `struct logging_settings` provides the foundation for logging configuration, which will be extended to support the unified system's log level and hostname settings.\r\n\r\n- **Platform Utilities** (`src/platform/platform.h`): Platform-specific functions for hostname retrieval and system information will be leveraged for the hostname component of log messages.\r\n\r\n- **String Utilities** (`src/utils/string/string_shims.h`): Existing safe string manipulation functions will be used for log message formatting and hostname handling to prevent buffer overflows.\r\n\r\n- **Memory Management** (`src/utils/memory/memory_manager.h`): The existing memory management utilities will be used for any temporary buffer allocation, ensuring consistent memory handling patterns.\r\n\r\n### Integration Points\r\n\r\n- **Configuration Loading** (`src/core/lifecycle/config_lifecycle.c`): The unified logging system will integrate with the existing configuration loading process, reading log level settings during system initialization.\r\n\r\n- **Application Config Structure**: The `struct application_config` will be extended with unified logging configuration, replacing the existing fragmented logging settings.\r\n\r\n- **Error Handling System** (`src/utils/error/error_handling.h`): The unified logging will integrate with the existing error handling utilities to provide consistent error reporting and recovery.\r\n\r\n- **Thread Safety**: Integration with existing pthread mutex patterns used throughout the codebase for consistent thread-safe operations.\r\n\r\n## Architecture\r\n\r\nThe unified logging system follows a layered architecture with clear separation of concerns:\r\n\r\n1. **API Layer**: Simple function-based interface for all logging operations\r\n2. **Formatting Layer**: Standardized message formatting with timestamp, hostname, and component identification\r\n3. **Output Layer**: Thread-safe stdout output with buffering optimization\r\n4. **Configuration Layer**: Integration with existing configuration management\r\n\r\n### Modular Design Principles\r\n\r\n- **Single File Responsibility**: `unified_logging.c` handles all logging functionality, `unified_logging.h` provides the public API\r\n- **Component Isolation**: The logging system is completely independent and can be used by any component without cross-dependencies\r\n- **Service Layer Separation**: Clear separation between the public API, internal formatting logic, and output handling\r\n- **Utility Modularity**: Focused single-purpose module that provides one well-defined service to the entire application\r\n\r\n```mermaid\r\ngraph TD\r\n    A[Application Code] --> B[Unified Logging API]\r\n    B --> C[Log Level Check]\r\n    C --> D[Message Formatting]\r\n    D --> E[Hostname Resolution]\r\n    D --> F[Timestamp Generation]\r\n    D --> G[Component Path Building]\r\n    E --> H[Output Formatting]\r\n    F --> H\r\n    G --> H\r\n    H --> I[Thread-Safe Output]\r\n    I --> J[stdout]\r\n\r\n    K[Configuration System] --> L[Log Level Setting]\r\n    L --> C\r\n\r\n    style A fill:#e1f5fe\r\n    style B fill:#f3e5f5\r\n    style I fill:#e8f5e8\r\n    style J fill:#fff3e0\r\n```\r\n\r\n## Components and Interfaces\r\n\r\n### Unified Logging Core\r\n- **Purpose:** Provides the main logging API and coordinates all logging operations\r\n- **Interfaces:**\r\n  - `log_error(const char* format, ...)` - Error level logging\r\n  - `log_warning(const char* format, ...)` - Warning level logging\r\n  - `log_info(const char* format, ...)` - Info level logging\r\n  - `log_debug(const char* format, ...)` - Debug level logging\r\n- **Dependencies:** Configuration system, platform utilities for hostname\r\n- **Reuses:** Existing string utilities, memory management patterns\r\n\r\n### Contextual Logging Component\r\n- **Purpose:** Provides context-aware logging with service and operation identification\r\n- **Interfaces:**\r\n  - `log_error_ctx(const log_context_t* ctx, const char* format, ...)` - Contextual error logging\r\n  - `log_info_ctx(const log_context_t* ctx, const char* format, ...)` - Contextual info logging\r\n  - `log_context_create(const char* component, const char* operation)` - Context creation\r\n  - `log_context_destroy(log_context_t* ctx)` - Context cleanup\r\n- **Dependencies:** Memory management utilities\r\n- **Reuses:** Existing memory allocation patterns, string handling utilities\r\n\r\n### Configuration Integration Component\r\n- **Purpose:** Manages logging configuration and provides runtime settings\r\n- **Interfaces:**\r\n  - `log_config_init(void)` - Initialize logging from application config\r\n  - `log_config_cleanup(void)` - Cleanup logging resources\r\n  - `log_is_level_enabled(log_level_t level)` - Check if level is enabled\r\n- **Dependencies:** Configuration system (`struct logging_settings`)\r\n- **Reuses:** Existing configuration loading patterns, lifecycle management\r\n\r\n### Format Engine Component\r\n- **Purpose:** Generates standardized log message format with all required components\r\n- **Interfaces:**\r\n  - `format_log_message(log_level_t level, const char* hostname, const char* component_path, const char* message)` - Internal formatting\r\n  - `get_timestamp_string(char* buffer, size_t size)` - ISO timestamp generation\r\n  - `get_hostname_string(char* buffer, size_t size)` - System hostname retrieval\r\n- **Dependencies:** System time functions, platform hostname utilities\r\n- **Reuses:** Existing timestamp utilities from platform_logging, string manipulation utilities\r\n\r\n## Data Models\r\n\r\n### Log Context Structure\r\n```c\r\ntypedef struct {\r\n    char component[32];    // Component name (e.g., \"onvif.device\", \"platform.video\")\r\n    char operation[32];    // Operation name (e.g., \"get_capabilities\", \"init\")\r\n    char session_id[16];   // Optional session identifier for request tracing\r\n} log_context_t;\r\n```\r\n\r\n### Log Level Enumeration\r\n```c\r\ntypedef enum {\r\n    LOG_LEVEL_TRACE = 0,   // Most verbose debugging information\r\n    LOG_LEVEL_DEBUG = 1,   // Debug information for development\r\n    LOG_LEVEL_INFO = 2,    // General informational messages\r\n    LOG_LEVEL_NOTICE = 3,  // Significant but normal events\r\n    LOG_LEVEL_WARNING = 4, // Warning conditions that should be noted\r\n    LOG_LEVEL_ERROR = 5,   // Error conditions that need attention\r\n    LOG_LEVEL_FATAL = 6    // Fatal errors that may cause system failure\r\n} log_level_t;\r\n```\r\n\r\n### Configuration Structure\r\n```c\r\ntypedef struct {\r\n    log_level_t min_level;     // Minimum log level to output\r\n    bool enable_timestamps;    // Include timestamps in output (always true)\r\n    bool enable_hostname;      // Include hostname in output (always true)\r\n    char hostname[64];         // Cached system hostname\r\n    pthread_mutex_t mutex;     // Thread safety mutex\r\n} log_config_t;\r\n```\r\n\r\n## Error Handling\r\n\r\n### Error Scenarios\r\n\r\n1. **Configuration Loading Failure**\r\n   - **Handling:** Use default log level (INFO), continue with degraded functionality\r\n   - **User Impact:** Logging works with default settings, no service interruption\r\n\r\n2. **Hostname Resolution Failure**\r\n   - **Handling:** Use fallback hostname \"UNKNOWN-HOST\", log warning about hostname failure\r\n   - **User Impact:** Logs show fallback hostname, functionality continues normally\r\n\r\n3. **Output Failure (stdout unavailable)**\r\n   - **Handling:** Attempt stderr output as fallback, no exceptions thrown\r\n   - **User Impact:** Logs may appear on stderr instead of stdout, no application crash\r\n\r\n4. **Memory Allocation Failure for Context**\r\n   - **Handling:** Return NULL from context creation, graceful degradation to non-contextual logging\r\n   - **User Impact:** Logs lack context information but continue to work\r\n\r\n5. **Thread Mutex Lock Failure**\r\n   - **Handling:** Continue without locking, accept potential race conditions over application failure\r\n   - **User Impact:** Possible garbled log output under heavy load, but no crashes\r\n\r\n6. **Format String Vulnerabilities**\r\n   - **Handling:** Input validation and sanitization, limited format specifier support\r\n   - **User Impact:** Safe logging operation, potential sanitization of malicious input\r\n\r\n## Testing Strategy\r\n\r\n### Unit Testing\r\n\r\n**Core Function Testing:**\r\n- Test all log level functions (`log_error`, `log_info`, etc.) with various message formats\r\n- Verify log level filtering works correctly (disabled levels produce no output)\r\n- Test context creation, usage, and cleanup operations\r\n- Validate timestamp and hostname formatting functions\r\n\r\n**Error Condition Testing:**\r\n- Test behavior with NULL parameters, invalid format strings\r\n- Test configuration loading with missing/corrupt config files\r\n- Test thread safety with concurrent logging operations\r\n- Test memory allocation failures and recovery\r\n\r\n### Integration Testing\r\n\r\n**Configuration Integration:**\r\n- Test loading logging configuration from application config files\r\n- Verify integration with existing config lifecycle management\r\n- Test configuration changes and their effects on logging behavior\r\n\r\n**System Integration:**\r\n- Test logging from all major components (ONVIF services, platform layer, utilities)\r\n- Verify contextual logging works correctly across service boundaries\r\n- Test logging under system load with video streaming and ONVIF operations\r\n\r\n**Thread Safety Testing:**\r\n- Test concurrent logging from multiple threads (HTTP server, RTSP server, main daemon)\r\n- Verify no race conditions or deadlocks under heavy concurrent load\r\n- Test logging performance impact on real-time video operations\r\n\r\n### End-to-End Testing\r\n\r\n**Log Format Validation:**\r\n- Verify all log messages follow the exact required format: `YYYY-MM-DD HH:MM:SS,mmm LEVEL [HOSTNAME] component.path.identifier Message text`\r\n- Test log parsing with standard Unix tools (grep, awk, sed)\r\n- Validate timestamp accuracy and hostname resolution\r\n\r\n**Migration Testing:**\r\n- Test complete migration from existing logging systems\r\n- Verify no legacy logging calls remain in codebase\r\n- Test that all previous log information is preserved with new format\r\n\r\n**Performance Testing:**\r\n- Measure logging overhead impact on camera operations\r\n- Verify disabled log levels have zero performance cost\r\n- Test memory usage remains within 32KB limit under load\r\n\r\n**Production Scenario Testing:**\r\n- Test logging during camera startup, operation, and shutdown\r\n- Verify logs provide sufficient information for troubleshooting\r\n- Test log volume and stdout handling under continuous operation",
  "fileStats": {
    "size": 12846,
    "lines": 248,
    "lastModified": "2025-09-27T07:19:43.248Z"
  },
  "comments": []
}
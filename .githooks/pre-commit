#!/usr/bin/env bash
set -euo pipefail

# Pre-commit hook: Run code quality checks
# - cargo fmt (auto-formats and restages if needed)
# - cargo clippy -- -D warnings (Rust linting)
# - npm lint (JavaScript/TypeScript linting)
# - prettier --check (JavaScript/TypeScript formatting)

ROOT_DIR="$(git rev-parse --show-toplevel)"
cd "$ROOT_DIR"

# Custom cargo path
CARGO_BIN="/home/kmk/anyka-dev/toolchain/arm-anykav200-crosstool-ng/bin/cargo"
RUST_PROJECT_DIR="cross-compile/onvif-rust"
NPM_PROJECT_DIR="cross-compile/www"

STAGED_FILES=$(git diff --cached --name-only)

# Track if any checks failed
FAILED=0

# Check if Rust files are staged
RUST_FILES=$(printf "%s" "$STAGED_FILES" | grep -qE '\.(rs|toml)$' && echo "yes" || echo "")
# Check if JS/TS files are staged
JS_FILES=$(printf "%s" "$STAGED_FILES" | grep -qE '\.(js|jsx|ts|tsx|json|css|scss|html)$' && echo "yes" || echo "")

# 1. Rust formatting check (auto-formats if needed)
if [ -n "$RUST_FILES" ] && printf "%s" "$STAGED_FILES" | grep -q "^${RUST_PROJECT_DIR}/"; then
  echo "üîß Running cargo fmt for ${RUST_PROJECT_DIR}..."
  if [ -f "${RUST_PROJECT_DIR}/Cargo.toml" ]; then
    pushd "${RUST_PROJECT_DIR}" >/dev/null || exit 1
    # Optional setup script for toolchain / cross compilation configs (idempotent)
    if [ -x ./scripts/setup-cargo-config.sh ]; then
      ./scripts/setup-cargo-config.sh || true
    fi

    # Check formatting; if check fails, auto-format and stage changes
    if ! cargo fmt -- --check; then
      echo "‚öôÔ∏è  Formatting Rust sources (cargo fmt) and restaging changes..."
      cargo fmt || true
      popd >/dev/null || exit 1
      # Stage only modified or new files under cross-compile/onvif-rust
      # Run from repo root to ensure paths work correctly
      # Filter out deleted files (D prefix) and only restage existing files
      MODIFIED_FILES=$(git status --porcelain | grep '^.M\|^M.\|^A.\|^??' | awk '{print $2}' | grep "^${RUST_PROJECT_DIR}/" || true)
      if [ -n "$MODIFIED_FILES" ]; then
        echo "Restaging formatted files:"
        echo "$MODIFIED_FILES"
        echo "$MODIFIED_FILES" | xargs -r git add --
      else
        echo "No formatted files to restage"
      fi
    else
      echo "‚úÖ Rust sources are formatted"
      popd >/dev/null || exit 1
    fi
  else
    echo "‚ö†Ô∏è  ${RUST_PROJECT_DIR}/Cargo.toml not found; skipping cargo fmt"
  fi
fi

# 2. Rust clippy check
if [ -n "$RUST_FILES" ] && printf "%s" "$STAGED_FILES" | grep -q "^${RUST_PROJECT_DIR}/"; then
  echo "üîç Running cargo clippy for ${RUST_PROJECT_DIR}..."
  if [ -f "${RUST_PROJECT_DIR}/Cargo.toml" ]; then
    if [ -f "$CARGO_BIN" ]; then
      pushd "${RUST_PROJECT_DIR}" >/dev/null || exit 1
      # Optional setup script for toolchain / cross compilation configs (idempotent)
      if [ -x ./scripts/setup-cargo-config.sh ]; then
        ./scripts/setup-cargo-config.sh || true
      fi
      if ! "$CARGO_BIN" clippy -- -D warnings; then
        echo "‚ùå cargo clippy check failed"
        FAILED=1
      else
        echo "‚úÖ cargo clippy check passed"
      fi
      popd >/dev/null || exit 1
    else
      echo "‚ö†Ô∏è  Custom cargo binary not found at $CARGO_BIN, skipping cargo clippy"
    fi
  fi
fi

# 3. npm lint check
if [ -n "$JS_FILES" ] && printf "%s" "$STAGED_FILES" | grep -q "^${NPM_PROJECT_DIR}/"; then
  echo "üîç Running npm lint for ${NPM_PROJECT_DIR}..."
  if [ -f "${NPM_PROJECT_DIR}/package.json" ]; then
    pushd "${NPM_PROJECT_DIR}" >/dev/null || exit 1
    if ! npm run lint:fix; then
      echo "‚ùå npm lint check failed"
      echo "üí° Run 'npm run lint:fix' to fix linting issues"
      FAILED=1
    else
      echo "‚úÖ npm lint check passed"
    fi
    popd >/dev/null || exit 1
  else
    echo "‚ö†Ô∏è  ${NPM_PROJECT_DIR}/package.json not found; skipping npm lint"
  fi
fi

# 4. prettier check
if [ -n "$JS_FILES" ] && printf "%s" "$STAGED_FILES" | grep -q "^${NPM_PROJECT_DIR}/"; then
  echo "üé® Checking Prettier formatting for ${NPM_PROJECT_DIR}..."
  if [ -f "${NPM_PROJECT_DIR}/package.json" ]; then
    pushd "${NPM_PROJECT_DIR}" >/dev/null || exit 1
    if ! npm run prettier .; then
      echo "‚ùå Prettier formatting check failed"
      echo "üí° Run 'npm run prettier' to fix formatting issues"
      FAILED=1
    else
      echo "‚úÖ Prettier formatting check passed"
    fi
    popd >/dev/null || exit 1
  else
    echo "‚ö†Ô∏è  ${NPM_PROJECT_DIR}/package.json not found; skipping prettier check"
  fi
fi

# Exit with failure if any check failed
if [ $FAILED -eq 1 ]; then
  echo "‚ùå Pre-commit checks failed. Please fix the issues above before committing."
  exit 1
fi

echo "‚úÖ All pre-commit checks passed!"
exit 0

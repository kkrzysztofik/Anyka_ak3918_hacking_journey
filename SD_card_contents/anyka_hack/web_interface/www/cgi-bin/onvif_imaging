#!/bin/sh
#
# ONVIF Imaging controls for Anyka AK3918 camera
# Provides brightness, contrast, and other imaging adjustments via ONVIF
#

[ -f /mnt/anyka_hack/common.sh ] && . /mnt/anyka_hack/common.sh

if [ -f /data/www/index.html ]; then
    . /data/www/cgi-bin/header
else
    . /mnt/anyka_hack/web_interface/www/cgi-bin/header
fi

if [ -f /mnt/tmp/token.txt ] && [ "$token" = "$(readline 1 /mnt/tmp/token.txt)" ]; then
ipadd=`ip route get 1 | awk '{print $NF;exit}'`
onvif_port=8080

# Function to get current imaging settings
get_imaging_settings() {
    local soap_request="<?xml version=\"1.0\" encoding=\"UTF-8\"?>
<soap:Envelope xmlns:soap=\"http://www.w3.org/2003/05/soap-envelope\" xmlns:timg=\"http://www.onvif.org/ver20/imaging/wsdl\">
<soap:Header/>
<soap:Body>
<timg:GetImagingSettings>
<timg:VideoSourceToken>VideoSourceToken</timg:VideoSourceToken>
</timg:GetImagingSettings>
</soap:Body>
</soap:Envelope>"

    echo "$soap_request" | curl -s -X POST \
        -H "Content-Type: application/soap+xml; charset=utf-8" \
        -H "SOAPAction: \"http://www.onvif.org/ver20/imaging/wsdl/GetImagingSettings\"" \
        -d @- \
        "http://$ipadd:$onvif_port/onvif/imaging_service"
}

# Function to set imaging settings
set_imaging_settings() {
    local brightness="$1"
    local contrast="$2"
    local saturation="$3"
    
    local soap_request="<?xml version=\"1.0\" encoding=\"UTF-8\"?>
<soap:Envelope xmlns:soap=\"http://www.w3.org/2003/05/soap-envelope\" xmlns:timg=\"http://www.onvif.org/ver20/imaging/wsdl\" xmlns:tt=\"http://www.onvif.org/ver10/schema\">
<soap:Header/>
<soap:Body>
<timg:SetImagingSettings>
<timg:VideoSourceToken>VideoSourceToken</timg:VideoSourceToken>
<timg:ImagingSettings>
<tt:Brightness>$brightness</tt:Brightness>
<tt:Contrast>$contrast</tt:Contrast>
<tt:ColorSaturation>$saturation</tt:ColorSaturation>
</timg:ImagingSettings>
</timg:ImagingSettings>
</timg:SetImagingSettings>
</soap:Body>
</soap:Envelope>"

    echo "$soap_request" | curl -s -X POST \
        -H "Content-Type: application/soap+xml; charset=utf-8" \
        -H "SOAPAction: \"http://www.onvif.org/ver20/imaging/wsdl/SetImagingSettings\"" \
        -d @- \
        "http://$ipadd:$onvif_port/onvif/imaging_service"
}

# Handle imaging commands
case "$command" in
    "set_brightness")
        if [ -n "$brightness" ]; then
            set_imaging_settings "$brightness" "$contrast" "$saturation"
        fi
        ;;
    "set_contrast")
        if [ -n "$contrast" ]; then
            set_imaging_settings "$brightness" "$contrast" "$saturation"
        fi
        ;;
    "set_saturation")
        if [ -n "$saturation" ]; then
            set_imaging_settings "$brightness" "$contrast" "$saturation"
        fi
        ;;
    "reset_imaging")
        set_imaging_settings "0" "0" "0"
        ;;
esac

# Default values
brightness=${brightness:-0}
contrast=${contrast:-0}
saturation=${saturation:-0}

cat <<EOT
<!DOCTYPE html>
<html>
<head>
<title>ONVIF Imaging Controls</title>
<link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAADElEQVQI12P4//8/AAX+Av7czFnnAAAAAElFTkSuQmCC">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="/styles.css">
</head>
<body>
<div class="topnav">
  <a href="/cgi-bin/webui_onvif?token=$token">Home</a>
  <a class="active" href="/cgi-bin/onvif_imaging?token=$token">Imaging</a>
  <a href="/cgi-bin/settings?token=$token">Settings</a>
  <a href="/cgi-bin/system?token=$token">System</a>
  <a href="/cgi-bin/events?token=$token">Events</a>
  <a href="/cgi-bin/login">Exit</a>
</div>
<section>

<div class="card">
<h2>ONVIF Imaging Controls</h2>

<form method="get" action="onvif_imaging">
<input type="hidden" name="token" value="$token">
<input type="hidden" name="command" value="set_imaging">

<table style="width: 100%;">
<tr>
<td><label for="brightness">Brightness (-100 to 100):</label></td>
<td><input type="range" id="brightness" name="brightness" min="-100" max="100" value="$brightness" onchange="updatePreview()"></td>
<td><span id="brightness_value">$brightness</span></td>
</tr>
<tr>
<td><label for="contrast">Contrast (-100 to 100):</label></td>
<td><input type="range" id="contrast" name="contrast" min="-100" max="100" value="$contrast" onchange="updatePreview()"></td>
<td><span id="contrast_value">$contrast</span></td>
</tr>
<tr>
<td><label for="saturation">Saturation (-100 to 100):</label></td>
<td><input type="range" id="saturation" name="saturation" min="-100" max="100" value="$saturation" onchange="updatePreview()"></td>
<td><span id="saturation_value">$saturation</span></td>
</tr>
</table>

<br>
<button type="submit" name="command" value="set_imaging">Apply Settings</button>
<button type="submit" name="command" value="reset_imaging">Reset to Default</button>
</form>

<br>
<img id="preview" style="max-width:98%; border: 1px solid #ccc;" src="http://$ipadd:3000/preview.jpeg"/>
</div>

<div class="card">
<h2>Quick Presets</h2>
<button onclick="setPreset(-50, 0, 0)">Low Light</button>
<button onclick="setPreset(0, 50, 0)">High Contrast</button>
<button onclick="setPreset(0, 0, 50)">Vivid Colors</button>
<button onclick="setPreset(0, 0, 0)">Normal</button>
</div>

</section>

<script>
function updatePreview() {
    document.getElementById('brightness_value').textContent = document.getElementById('brightness').value;
    document.getElementById('contrast_value').textContent = document.getElementById('contrast').value;
    document.getElementById('saturation_value').textContent = document.getElementById('saturation').value;
    
    // Update preview image with timestamp to force refresh
    document.getElementById('preview').src = "http://$ipadd:3000/preview.jpeg?" + new Date().getTime();
}

function setPreset(brightness, contrast, saturation) {
    document.getElementById('brightness').value = brightness;
    document.getElementById('contrast').value = contrast;
    document.getElementById('saturation').value = saturation;
    updatePreview();
    
    // Auto-submit the form
    var form = document.querySelector('form');
    var brightnessInput = document.createElement('input');
    brightnessInput.type = 'hidden';
    brightnessInput.name = 'brightness';
    brightnessInput.value = brightness;
    form.appendChild(brightnessInput);
    
    var contrastInput = document.createElement('input');
    contrastInput.type = 'hidden';
    contrastInput.name = 'contrast';
    contrastInput.value = contrast;
    form.appendChild(contrastInput);
    
    var saturationInput = document.createElement('input');
    saturationInput.type = 'hidden';
    saturationInput.name = 'saturation';
    saturationInput.value = saturation;
    form.appendChild(saturationInput);
    
    var commandInput = document.createElement('input');
    commandInput.type = 'hidden';
    commandInput.name = 'command';
    commandInput.value = 'set_imaging';
    form.appendChild(commandInput);
    
    form.submit();
}

// Update preview every 2 seconds
setInterval(function() { 
    document.getElementById("preview").src = "http://$ipadd:3000/preview.jpeg?" + new Date().getTime(); 
}, 2000);
</script>

</body>
</html>
EOT

else
    if [ -f /data/www/index.html ]; then
        . /data/www/cgi-bin/footer
    else
        . /mnt/anyka_hack/web_interface/www/cgi-bin/footer
    fi
fi

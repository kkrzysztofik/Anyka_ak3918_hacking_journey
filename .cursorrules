# Cursor AI Rules for Anyka AK3918 Hacking Journey

## Project Overview
This repository documents reverse-engineering and hacks for Anyka AK3918-based cameras. The codebase is a mix of cross-compile app sources, SD-card payloads, and notes for modifying device rootfs (squashfs `*.sqsh4`).

## Current Project Status (Updated)
**Active Development Focus:** ONVIF implementation for Anyka AK3918 cameras
- **ONVIF Daemon (`cross-compile/onvif/`):** Complete ONVIF 2.5 compliant implementation with Device, Media, PTZ, and Imaging services
- **Platform Abstraction:** Unified platform layer (`platform_anyka.c`) providing hardware abstraction for video input, PTZ control, and audio
- **Service Architecture:** Modular SOAP-based web services with proper XML parsing and response generation
- **Recent Changes:** Modified ONVIF service implementations with improved error handling and platform integration

## Major Components
- `cross-compile/onvif/` â€” **CURRENT FOCUS** - Complete ONVIF 2.5 implementation with Device, Media, PTZ, and Imaging services
- `cross-compile/` â€” Source and build scripts for individual apps (e.g., `libre_anyka_app`, `aenc_demo`, `ak_snapshot`, `ptz_daemon`). Each subproject usually has a `build.sh` or `Makefile`.
- `SD_card_contents/anyka_hack/` â€” Payload and web UI that run from SD card. This is the easiest test path and typical dev workflow for testing changes on device.
- `newroot/` and prepared squashfs images (`busyroot.sqsh4`, `busyusr.sqsh4`, `newroot.sqsh4`) â€” Prebuilt root/user fs images used for flashing.
- `hack_process/`, `README.md`, `Images/`, and `UART_logs/` â€” Docs and logs useful for debugging and reproducing device behavior.

## Quick Start Entry Points
- To iterate fast: edit or add files under `cross-compile/<app>/` and test via the SD-card hack in `SD_card_contents/anyka_hack/`.
- Key READMEs:
  - Top-level `README.md` â€” project goals, features, SD-card hack quick start and important device commands.
  - `cross-compile/README.md` â€” cross-compile environment notes and `setup.sh` usage.

## Build & Cross-Compile Environment
- This project targets an Anyka 32-bit toolchain (`arm-anykav200-*`) expected to be installed under `/opt/arm-anykav200-crosstool/usr/bin`.
- Many `build.sh` scripts assume you have exported that path into `PATH`: `export PATH=$PATH:/opt/arm-anykav200-crosstool/usr/bin`

### Cross-compilation Environment Options:
1. **Docker (Recommended for Windows/Modern Systems):**
   - Build image: `cd cross-compile && .\docker-build.ps1` (Windows) or `./docker-build.sh` (Linux/Mac)
   - Interactive shell: `docker run -it --rm -v ${PWD}:/workspace anyka-cross-compile`
   - Direct build: `docker run --rm -v ${PWD}:/workspace anyka-cross-compile make -C /workspace/<project>`

2. **Ubuntu 16.04 (Traditional):** Older 32-bit-friendly Ubuntu because toolchain is 32-bit

3. **Pre-built Live USB:** Available from share link in `cross-compile/README.md` with toolchain pre-installed

### Typical Compile Flow:
```bash
cd cross-compile/anyka_v380ipcam_experiments/apps/ak_snapshot
# ensure PATH contains arm-anykav200-crosstool bin dir
./build or ./build.sh
```

## Device/Runtime Conventions
- Rootfs and userfs are squashfs images flashed from the device using `updater`:
  - Read/backup: `/dev/mtdblock4` (root), `/dev/mtdblock5` (user)
  - Install examples: `updater local A=/mnt/newroot.sqsh4` or `updater local B=/mnt/busyusr.sqsh4`
- Web UI served from device port 80 (busybox `httpd`). WebUI assets in `SD_card_contents/anyka_hack/www` (copy to `/etc/jffs2/www` when installing to flash).
- RTSP stream endpoint: `rtsp://<IP>:554/vs0` (unprotected by password). Snapshot BMP: port `3000` (e.g., `http://IP:3000`).

### Useful Device Files/Dirs:
- `/etc/init.d/rc.local` â€” modified during permanent hack to run `gergehack.sh`
- `/usr/bin` and `/usr/sbin` â€” apps copied here in permanent hack (`libre_anyka_app`, `ptz_daemon_dyn`, etc.)
- `/etc/jffs2/www` â€” web UI on flash

## Debugging & Testing
- Local quick test: use the SD-card hack. It boots without modifying flash and gives telnet root access.
- Serial/UART logs: see `UART_logs/` for historical logs and expected boot messages.
- On-device commands often used:
  - `cat /dev/mtdblock4 > /mnt/mtdblock4.bin` (backup)
  - `unsquashfs mtdblock4.bin` / `mksquashfs squashfs-root newroot.sqsh4 -b 131072 -comp xz`

## Project-Specific Patterns & Gotchas
- Toolchain & environment: build scripts assume a host environment that includes 32-bit libs and the specific Anyka toolchain.
- Web UI / auth: the web UI uses an MD5-based token login and is explicitly insecure â€” do not attempt to retrofit modern auth.
- Packaging format: compressed squashfs images use `*.sqsh4` and specific blocksize and XZ options. Keep these options when recreating images.
- Many helper scripts expect `busybox` behaviour; the repo replaces/relies on a custom `busybox` in some cases.

## Key Files & Directories for Changes

### ONVIF Implementation (Current Focus)
- `cross-compile/onvif/src/main/onvifd.c` â€” Main ONVIF daemon entry point with service initialization
- `cross-compile/onvif/src/services/device/onvif_device.c` â€” Device service implementation (capabilities, system info)
- `cross-compile/onvif/src/services/media/onvif_media.c` â€” Media service implementation (profiles, stream URIs)
- `cross-compile/onvif/src/services/ptz/onvif_ptz.c` â€” PTZ service implementation (movement, presets, status)
- `cross-compile/onvif/src/services/imaging/onvif_imaging.c` â€” Imaging service implementation (brightness, contrast, etc.)
- `cross-compile/onvif/src/platform/platform_anyka.c` â€” Platform abstraction layer for Anyka hardware
- `cross-compile/onvif/src/utils/config.c` â€” Configuration management for ONVIF settings

### Other Key Components
- `cross-compile/libre_anyka_app/` â€” app combining RTSP, snapshots, motion detect.
- `cross-compile/IOT-ANYKA-PTZdaemon/` â€” PTZ daemon sources and build scripts.
- `SD_card_contents/anyka_hack/` â€” web UI, dropbear, helper scripts used for SD-card testing.
- `newroot/` â€” prepared rootfs images and `updater.txt` notes.
- `UART_logs/` â€” serial logs that show boot behavior used elsewhere in docs.

## AI Agent Development Workflow

### ONVIF Development (Current Priority)
1. **ONVIF Service Changes:** Modify files in `cross-compile/onvif/src/services/` for specific service implementations
2. **Platform Integration:** Update `cross-compile/onvif/src/platform/platform_anyka.c` for hardware abstraction changes
3. **Configuration:** Modify `cross-compile/onvif/src/utils/config.c` for ONVIF settings management
4. **Build ONVIF:** Use `cd cross-compile/onvif && make` or Docker build
5. **Test:** Deploy to SD card and test ONVIF services via SOAP clients or ONVIF test tools

### General Development Workflow
1. Make a small change under `cross-compile/<app>/`.
2. Build locally in a compatible environment:
   - **Docker (Recommended):** `docker run --rm -v ${PWD}:/workspace anyka-cross-compile make -C /workspace/<project>`
   - **Traditional:** Export `PATH` to Anyka toolchain
   - **If unavailable:** Produce a patch and include a short explanation of toolchain expectations.
3. Test using the SD-card payload: update files under `SD_card_contents/anyka_hack/`, write to an SD card, boot camera with SD inserted, verify feature via web UI / RTSP.
4. If modifying rootfs images, document exact `mksquashfs` command and options used.

## Reference Implementation: `akipc`
- The `akipc` tree is a reference implementation (chip/vendor-provided) that shows how the original camera firmware implements APIs, initialization, and configuration.
- Use it as the canonical example when:
  - reverse-engineering how the camera starts services and uses device files
  - matching IPC/CLI commands and config keys used by webUI and other apps
  - verifying binary and library ABI expectations before replacing or reimplementing a system binary.

## Component & Platform Libraries
- `component/` contains reusable pieces extracted from stock firmware: drivers, third-party libs, and helper tools.
- `platform/` holds board/platform-specific glue: sensor selection and initialization, board pin mappings, and other low-level integration.
- When modifying `busybox` or other low-level component binaries, remember the rootfs size and `mksquashfs` options matter.

## Logging Integration
- The project's logging functionality should be integrated into the platform_anyka abstraction and declared in platform.h, using standard function names instead of the ak_ prefix.

## ONVIF Service Architecture
- **Device Service:** Provides device capabilities, system information, and service discovery
- **Media Service:** Manages video/audio profiles, stream URIs, and encoder configurations  
- **PTZ Service:** Handles pan-tilt-zoom control, presets, and movement operations
- **Imaging Service:** Controls image quality settings (brightness, contrast, saturation, etc.)
- **Platform Layer:** Hardware abstraction for video input, PTZ hardware, and audio processing
- **Configuration:** INI-based config system with fallback to `/etc/jffs2/anyka_cfg.ini`

## Current ONVIF Implementation Status
- âœ… **Device Service:** Complete with capabilities, system info, and service discovery
- âœ… **Media Service:** Complete with dual profiles (main/sub), stream URIs, and encoder configs
- âœ… **PTZ Service:** Complete with absolute/relative/continuous movement, presets, and status
- âœ… **Imaging Service:** Complete with image quality controls and day/night switching
- âœ… **Platform Integration:** Unified abstraction layer for Anyka hardware
- âœ… **SOAP/XML:** Proper SOAP envelope generation and XML parsing
- ðŸ”„ **Testing:** Ready for SD card deployment and ONVIF client testing

## Example Actionable Prompts
- "I modified `cross-compile/onvif/src/services/ptz/onvif_ptz.c` to improve preset handling â€” please build using Docker and test PTZ functionality via ONVIF client."
- "Update `cross-compile/onvif/src/platform/platform_anyka.c` to add better error handling for PTZ initialization failures."
- "I changed `cross-compile/libre_anyka_app/main.c` to add logging â€” please build using Docker and test by copying the new binary to `SD_card_contents/anyka_hack/usr/bin/` and booting an SD-card image."
- "Patch updates `www/js/app.js` for the web UI. After applying, pack the SD payload and test UI on device at `http://<device-ip>`; capture network requests and serial log if UI doesn't load."
